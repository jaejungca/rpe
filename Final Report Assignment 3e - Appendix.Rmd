---
title: "Final Report Assignment 3e - Appendix"
author: "Jae Jung"
date: "2023-05-10: Updated on `r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: false
    highlight: espresso
    theme: journal
    number_sections: yes
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages

```{r}
# install.packages("here")
# install.packages("labelled")
# install.packages("sjlabelled")
# install.packages("sjPlot")
# install.packages("janitor")

# Data wrangling packages
library(tidyverse)  # general use ----
library(here)       # file paths  ----
library(haven)      # import .sav files ----  
library(labelled)   # tools for labelled data ----
library(sjlabelled) # more tools for labelled data ----
library(sjPlot)     # creates variable table
library(janitor)
library(naniar)

#Tabling package
library(kableExtra)
library(scales)
library(GGally)     # has ggcorr()
library(ggthemes)
library(ggtext)
library(viridis)

theme_set(theme_bw())
```

# Import SPSS data

```{r}
df <- read_sav("Cal Poly Farm Store data 4.10 with segments good completes only.sav")

dim(df)
head(df)
glimpse(df)
```

# Cleaning up
```{r}
df <- df %>% clean_names()

head(df)
```

# Viewing data dictionary
 
```{r}
glimpse(df)
view_df(df)
```


# Clean up Segments

```{r}
# segment reorder
 
df <- df %>% 
  mutate(segment = haven::as_factor(segment)) %>% 
  mutate(segment = fct_relevel(segment, "Identity Shoppers", "Novelty Hunters", "Health Nuts", "Solo Supporters", "Conventional Shoppers"))

class(df$county)
levels(df$segment)

df %>% 
  count(segment)
```

# Creating CPP Students (undergraduate + Grad)  

```{r}

# Creating cpp_affiliation_students
df <- df %>% 
  mutate(cpp_affiliation_students = case_when((cpp_affiliation_1 == 1 | cpp_affiliation_2 == 1) ~ 1,
                                              TRUE ~ 0)) %>% 
  set_variable_labels(cpp_affiliation_students = "CPP Students (Under + Graduate)") %>% 
  set_value_labels(cpp_affiliation_students = c("CPP Students (Under + Graduate)" = 1, "0" = 0)) 

df %>% count(cpp_affiliation_students)
```

# Functions

## Creating a function for renaming segments

```{r}
rename_segment <- function(tbl) {
  tbl %>% 
    set_value_labels(segment = c("Solo Supporters" = 1,
                               "Conventional Shoppers" = 2,
                               "Health Nuts" = 3,
                               "Identity Shoppers" = 4,
                               "Novelty Hunters" = 5))
}
```


## Create a function to draw a barplot for one categorical variable

```{r}
create_barplot_one_var <- function(tbl, var){
  
  var <- enquo(var)
  
  tbl %>% 
    select(!!var) %>% 
    mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
    count(!!var) %>% 
    mutate(percent = n/sum(n)) %>% 
    mutate(!!var := fct_reorder(!!var, n)) %>% 
    ggplot(aes(x = percent, y = !!var, fill = !!var)) +
    geom_col() +
    geom_text(aes(label = paste0(sprintf("%1.0f", percent*100), "%")),
              position = position_stack(vjust = 1.05),
              size = 4,
              color = "black") +
     scale_fill_viridis(alpha = 1,
                        begin = 0.3,
                        end = 1,
                        direction = 1,
                        discrete = TRUE,
                        option = "D") +
    scale_x_continuous(labels = percent_format()) +
    theme_bw() +
    theme(legend.position = "none") 
}

df %>% 
  create_barplot_one_var(segment) +
  labs(x = "Percent of the sample",
       y = NULL,
       title = "Sample breakdown by segments (%)",
       subtitle = "Highlights: Conventional Shoppers are largest while Identity Shoppers smallest. \n(N = 270)",
       caption = "segment. \n\"5-segment solution\"")+
  guides(fill = "none")
```

## Create a barplot with two cat vars by cutting by segment

```{r}
create_barplot_by_segment <- function(tbl, var) {
  
  var <- enquo(var)
  tbl %>% 
    select(segment, !!var) %>% 
    mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
    group_by(segment, !!var) %>% 
    tally() %>% 
    mutate(percent = n/sum(n)) %>% 
    ungroup() %>% 
    filter(!is.na(!!var)) %>% 
    filter(!!var != "0") %>%      
    mutate(!!var := fct_reorder(!!var, percent, .fun = mean)) %>% 
    ggplot(aes(percent, !!var, fill = segment)) +
    geom_col() +
    geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
              position = position_stack(vjust = 0.9),
              color = "black",
              size = 3.5) +
    scale_x_continuous(labels = percent) +
    scale_fill_viridis(alpha = 1,
                      begin = 0.3,
                      end = 1,
                      direction = 1,
                      discrete = TRUE,
                      option = "D") +
    facet_grid(~ segment) +
    theme_bw() +
    theme(legend.position = "none")
}
```


## Create barplot for two categorical variables (*Didn't work*)

```{r}
create_barplot_two_vars <- function(tbl, var1, var2) {
  var1 <- enquo(var1)
  var2 <- enquo(var2)
  tbl %>% 
    select(!!var1, !!var2) %>% 
    mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
    group_by(!!var1, !!var2) %>% 
    tally() %>% 
    mutate(percent = n/sum(n)) %>% 
    ungroup() %>% 
    mutate(!!var2 := fct_reorder(!!var2, percent, .fun = mean)) %>% 
    ggplot(aes(percent, !!var2, fill = !!var1)) +
    geom_col() +
    geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
              position = position_stack(vjust = 0.9),
              color = "black",
              size = 3.5) +
    scale_x_continuous(labels = percent) +
    scale_fill_viridis(alpha = 1,
                      begin = 0.3,
                      end = 1,
                      direction = 1,
                      discrete = TRUE,
                      option = "D") +
    facet_grid(~ !!var1) +
    theme_bw() +
    theme(legend.position = "none")
}

df %>% 
  create_barplot_two_vars(income_3_cat, segment)
```

## Creating a table of all multi-select categories by segment

```{r}
#bind_row(): 50 rows (10*5 cats)

tabulate_seg_by_cat <- function(tbl, cat) {
tbl %>% 
  select(segment, {{cat}}) %>% 
  rename(class = {{cat}}) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(segment, class) %>% 
  tally() %>% 
  mutate(percent = n/sum(n))
}

t_seg_by_aff <- 
  df %>% tabulate_seg_by_cat(cpp_affiliation_students) %>% 
bind_rows(df %>% tabulate_seg_by_cat(cpp_affiliation_3)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(cpp_affiliation_4)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(cpp_affiliation_5)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(cpp_affiliation_6)) %>% ungroup()

```

## Create a barplot with multi-select categories cutting by segment

```{r}
t_seg_by_aff %>% 
  filter(class != "0") %>% 
  mutate(class = fct_reorder(class, percent, .fun = mean)) %>% 
  ggplot(aes(percent, class, fill = segment)) +
  geom_col() +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 1.12),
            color = "black",
            size = 3.5) +
  scale_x_continuous(labels = percent) +
  scale_fill_viridis(alpha = 1,
                    begin = 0.3,
                    end = 1,
                    direction = 1,
                    discrete = TRUE,
                    option = "D") +
  facet_grid(~ segment) +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "CPP Affiliation by Segment",
       subtitle = "(N = 270)")

create_barplot_multi_cat_by_segment <- function(tbl, var) {
  
  var <- enquo(var)
  tbl %>% 
    mutate(!!var := fct_reorder(!!var, percent, .fun = mean)) %>% 
    ggplot(aes(percent, !!var, fill = segment)) +
    geom_col() +
    geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
              position = position_stack(vjust = 1.12),
              color = "black",
              size = 3.5) +
    scale_x_continuous(labels = percent) +
    scale_fill_viridis(alpha = 1,
                      begin = 0.3,
                      end = 1,
                      direction = 1,
                      discrete = TRUE,
                      option = "D") +
    facet_grid(~ segment) +
    theme_bw() +
    theme(legend.position = "none")
}

t_seg_by_aff %>% 
  filter(class != "0") %>% 
  create_barplot_multi_cat_by_segment(class)
```

## Create a table of all multi-select categories

```{r}
df %>% 
  select(product_store_attrib_1) %>% 
  rename(class = product_store_attrib_1) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(class) %>% 
  tally() %>% 
  mutate(percent = n/sum(n))

tabulate_by_cat <- function(tbl, cat) {
  
  tbl %>% 
    select({{cat}}) %>% 
    rename(class = {{cat}}) %>% 
    mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
    group_by(class) %>% 
    tally() %>% 
    mutate(percent = n/sum(n))
}

t_by_reasons <- 
  df %>% tabulate_by_cat(product_store_attrib_1) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_2)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_3)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_4)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_5)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_6)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_7)) %>%   
bind_rows(df %>% tabulate_by_cat(product_store_attrib_8)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_9)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_10)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_11)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_12)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_13)) %>% ungroup()
  
levels(t_by_reasons$class)
```

## Create a barplot with mult-select categories

```{r}
create_barplot_multi_cat <- function(tbl, var) {
  
  var <- enquo(var)
  
  tbl %>% 
    mutate(!!var := fct_reorder(!!var, percent, .fun = mean)) %>% 
    ggplot(aes(percent, !!var, fill = !!var)) +
    geom_col() +
    geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
              position = position_stack(vjust = 0.9),
              color = "black",
              size = 3.5) +
    scale_x_continuous(labels = percent) +
    scale_fill_viridis(alpha = 1,
                      begin = 0.3,
                      end = 1,
                      direction = 1,
                      discrete = TRUE,
                      option = "D") +
    theme_bw() +
    theme(legend.position = "none")
}

t_by_reasons %>% 
  filter(class != "0") %>% 
  create_barplot_multi_cat(class)
```

## Create a function to count sample size

```{r}
df %>% 
  count(a1_brand_overall) %>% 
  mutate(cum_count = cumsum(n))

calculate_sample_n <- function(tbl, var) {
  tbl %>% 
    count({{var}}) %>% 
    mutate(cum_n = cumsum(n))
}

df %>%calculate_sample_n(a1_brand_overall)
```


# income

```{r}
df %>% 
  select(income) %>% 
  #mutate(income = haven::as_factor(income)) %>% 
  distinct(income) %>% 
  arrange(income)

df %>% 
  count(income, sort = TRUE)

df %>% 
  filter(!is.na(income)) %>% #n = 269
  create_barplot_one_var(income) +
  labs(x = "Percent of participants",
     y = NULL,
     title = "Income Distribution (%) in the Sample",
     subtitle = "N = 269",
     caption = "income. Income brackets combined from \n\"What is the total income of your household before taxes? (Include yourself and everyone you live with.) Please select one response.\"")
```

## income_5_cat

```{r}
df <- df %>% 
  mutate(income_5_cat = case_when(income %in% c(1,2) ~ "Under $50K",
                            income == 3 ~ "$50,000 – $74,999",
                            income == 4 ~ "$75,000 – $99,999",
                            income == 5 ~ "$100,000 – $149,999",
                            income == 6 ~ "$150,000 or above",
                            TRUE ~ "Others")) %>% 
  mutate(income_5_cat = fct_relevel(income_5_cat, 
                              "Under $50K", 
                              "$50,000 – $74,999", 
                              "$75,000 – $99,999", 
                              "$100,000 – $149,999", 
                              "$150,000 or above")) 


df %>% count(income_5_cat)
df %>% 
  filter(income_5_cat!= "Others") %>% # n = 208
  create_barplot_one_var(income_5_cat)
```

## income_3_cat

```{r}
df %>% 
  count(income)

df <- df %>% 
  mutate(income_3_cat = case_when(income %in% c(1,2,3,4) ~ "Under $100K",
                            income == 5 ~ "$100,000 – $149,999",
                            income == 6 ~ "$150,000 or above",
                            TRUE ~ "Others")) %>% 
  mutate(income_3_cat = fct_relevel(income_3_cat, 
                              "Under $100K", 
                              "$100,000 – $149,999", 
                              "$150,000 or above")) 

df %>% 
  filter(income_3_cat!= "Others") %>% # n = 208
  create_barplot_one_var(income_3_cat)

view_df(df)
```


## income_3_cat by segment

```{r}
# faceting
df %>% #count(income_3_cat)
  filter(income_3_cat != "Others") %>% # n = 208
  create_barplot_by_segment(income_3_cat) +
  labs(x = "Percent of participants within segments",
       y = NULL,
       title = "Income by segment (%)",
       subtitle = "N = 208",
       caption = "")

```


## Income_5_cat by segment 
```{r}
df %>% #count(income)
  filter(income %in% c(1,2,3,4,5,6)) %>% # n = 208
  create_barplot_one_var(income)

df %>% 
  filter(income_5_cat != "Others") %>% 
  create_barplot_one_var(income_5_cat)

df %>% 
  filter(income_5_cat != "Others") %>% #n=208
  create_barplot_by_segment(income_5_cat) +
  labs(x = "Percent of participants within segments",
     y = NULL,
     title = "Income by Segment (%)",
     subtitle = "N = 208. Top two income categories ($100K or above) reprepresent the majorities \nfor conventional Shoppers and Novelty Hunters",
     caption = "income_5_cat, which is created by cleaning categories from \nincome. \"What is the total income of your household before taxes? (Include yourself and everyone you live with.) Please select one response.\"")
  
```

# Age

## Age: 6 cats

```{r}
df <- df %>% 
  mutate(age_6_cat = case_when(age >= 78 ~ "78+ (Post War)", 
                             age >= 69 ~ "69-77 (Boomers I)",
                             age >= 59 ~ "59-68 (Boomers II)",
                             age >= 43 ~ "43-58 (Gen X)",
                             age >= 27 ~ "27-42 (Millennials)",
                             age >= 18 ~ "18-26 (Gen Z)")) %>% 
  mutate(age_6_cat = fct_relevel(age_6_cat, 
                                 "18-26 (Gen Z)",
                                 "27-42 (Millennials)",
                                 "43-58 (Gen X)",
                                 "59-68 (Boomers II)",
                                 "69-77 (Boomers I)",
                                 "78+ (Post War)"))
levels(df$age_6_cat)
         
df %>%
  count(age_6_cat)

```

## Age: 4 cats
```{r}
 
df <- df %>% 
  mutate(age_4_cat = case_when(age >= 69 ~ "69+ (Boomers I + Post War)",
                             age >= 59 ~ "59-68 (Boomers II)",
                             age >= 43 ~ "43-58 (Gen X)",
                             age >= 18 ~ "18-42 (Gen Z + Gen Y)")) %>% 
  mutate(age_4_cat = fct_relevel(age_4_cat,
                                 "18-42 (Gen Z + Gen Y)",
                                 "43-58 (Gen X)",
                                 "59-68 (Boomers II)",
                                 "69+ (Boomers I + Post War)"))

levels(df$age_4_cat)

df %>%
  count(age_4_cat)

view_df(df)

# Create a function to clean up the age category
clean_age <- function(tbl) {
  tbl %>% 
    mutate(age_4_cat = case_when(age >= 69 ~ "69+ (Boomers I + Post War)",
                               age >= 59 ~ "59-68 (Boomers II)",
                               age >= 43 ~ "43-58 (Gen X)",
                               age >= 18 ~ "18-42 (Gen Z + Gen Y)")) %>% 
    mutate(age_4_cat = fct_relevel(age_4_cat,
                                   "18-42 (Gen Z + Gen Y)",
                                   "43-58 (Gen X)",
                                   "59-68 (Boomers II)",
                                   "69+ (Boomers I + Post War)"))
}

df %>% 
  clean_age() %>% 
  create_barplot_one_var(age_4_cat) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Age brackets in the Sample",
       subtitle = "N = 270",
       caption = "age_4_cat. This variable was created from original variable, \"age. \nWhat is your age? Please enter a numeric response.\"")
```

## Mean age by segment

```{r}
# segment by age (continuous)

df %>% 
  select(age, segment) %>% 
  mutate(segment = haven::as_factor(segment)) %>% 
  group_by(segment) %>% 
  summarise(age_avg = mean(age)) %>% 
  #mutate(segment = fct_rev(segment)) %>% 
  ggplot(aes(x = age_avg, y = segment, fill = segment)) +
  geom_col() +
  geom_text(aes(label = sprintf("%1.1f", age_avg)),
        position = position_stack(vjust = 0.9),
        color = "black",
        size = 4.0) +
  scale_fill_viridis(alpha = 1,
                    begin = 0.3,
                    end = 1,
                    direction = 1,
                    discrete = TRUE,
                    option = "D") +
  theme_bw()+
  theme(legend.position = "none") +
  labs(x = "",
       y = NULL,
       title =  "Average Age of Segments",
       subtitle = "N = 270. Identity Shoppers are youngest, while Solor Supporters are oldest",
       caption = "age. \n\"What is your age? Please enter a numericresponse.\"") +
  coord_flip()
```

## Age 4 categories by segment

```{r}
df %>% 
  create_barplot_by_segment(age_4_cat) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Age by Segment",
       subtitle = "N = 270. Most of the Identity Shoppers are Gen X and younger generations, while Solo Supporters tend be oldest)",
       caption = "age_4_cat. This variable was created from original variable, \"age. \nWhat is your age? Please enter a numeric response.\"")

```


# Affiliation by segments

## Creating CPP Students (undergraduate + Grad)  

```{r}

# Creating cpp_affiliation_students
df <- df %>% 
  mutate(cpp_affiliation_students = case_when((cpp_affiliation_1 == 1 | cpp_affiliation_2 == 1) ~ 1,
                                              TRUE ~ 0)) %>% 
  set_variable_labels(cpp_affiliation_students = "CPP Students (Under + Graduate)") %>% 
  set_value_labels(cpp_affiliation_students = c("CPP Students (Under + Graduate)" = 1, "0" = 0)) 

df %>% count(cpp_affiliation_students)
```

## Creating a table of all affiliation by segment infor

```{r}
#bind_row(): 50 rows (10*5 cats)

tabulate_seg_by_cat <- function(tbl, cat) {
tbl %>% 
  select(segment, {{cat}}) %>% 
  rename(class = {{cat}}) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(segment, class) %>% 
  tally() %>% 
  mutate(percent = n/sum(n))
}

t_seg_by_aff <- 
  df %>% tabulate_seg_by_cat(cpp_affiliation_students) %>% 
bind_rows(df %>% tabulate_seg_by_cat(cpp_affiliation_3)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(cpp_affiliation_4)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(cpp_affiliation_5)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(cpp_affiliation_6)) %>% ungroup()

t_seg_by_aff 
```

## Affiliation by segment

```{r}
t_seg_by_aff %>% 
  filter(class != "0") %>% 
  create_barplot_multi_cat_by_segment(class) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "CPP Affiliation by Segment",
       subtitle = "N = 270. Most Identity Shoppers and Solo Shoppers are not affiliated with CPP.",
       caption = "cpp_affiliation_1 to cpp_affiliation_6. \nAffiliations are listed in descending order of the percentages of affiliation categories in the sample. \n\"What is your affiliation with Cal Poly Pomona (CPP)? Please select all that apply. CPP\"")
```


# Demographics by Segment (Daniel)

## County

```{r}
# group_by(a, b) %>% tally()
df %>% 
  #count(county) %>% 
  select(segment, county) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(county) %>% 
  tally() %>% 
  mutate(percent = round(n/sum(n), digits = 2)) %>% 
  arrange(desc(percent)) %>% 
  kbl(caption = "Participants' County of Residence") %>% 
  kable_classic(full_width = F, html_font = "Cambria")
```


## County by segment

```{r}
# group_by(a) %>% count(b)


df %>% count(county)
df %>% view_df()

df %>% 
  create_barplot_by_segment(county) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "County by Segment",
       subtitle = "(N = 270)",
       caption = "county. \n\"What county do you reside in currently? Please select one response.\"")
```

## Zip code (top 5) by segment

```{r}
class(df$segment)
df %>% count(location, sort = TRUE)

df %>% 
  mutate(location = fct_lump_n(location, n = 5)) %>% 
  mutate(location = fct_recode(location, "91711 (Claremont)" = "91711",
                               "91789 (Walnut)" = "91789",
                               "91765 (Diamond Bar)" = "91765",
                               "91709 (Chino Hills)" = "91709",
                               "91786 (Upland)" = "91786")) %>% 
  #filter(location != "other") %>% 
  create_barplot_by_segment(location) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Top 5 Zip codes by Segment",
       subtitle = "N = 270. \nAll top five zip code areas are under about 10%. Health Nuts tend to live closeer than other groups with Claremont leading the way. \nMost of the Identity Shoppers who live nearby are concentrated in Walnut, Diamond Bar, and Chino Hills.",
       caption = "location. \n\"What is your zip code? Please enter a 5 digit numeric response.\"")

```

## Gender by segment

```{r}
df %>% count(gender_4_text)
#gender
df %>% 
  create_barplot_one_var(gender)+
  labs(x = "Percent of Participants in the sample",
       y = NULL,
       title = "Gender Distribution in the Sample",
       subtitle = "N = 270. ",
       caption = "gender. \n\"What is your gender? Please select one response.\"")

#gender by segment
df %>% 
  #count(gender) %>% 
  select(segment, gender) %>% 
  #filter(gender %in% c(1,2)) %>% 
  create_barplot_by_segment(gender) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Gender by Segment",
       subtitle = "N = 270. \nNovelty Hunters tend to be composed of more female than the average \nwhile Identity Shoppers tend to be composed of more males than the average",
       caption = "gender. \n\"What is your gender? Please select one response.\"")
```

## Ethnicity by Segment

### Ethnicity 4 cats

```{r}
# ethnicity 4 cats
df <- df %>% 
  mutate(ethnicity_4_cats = 
           case_when(ethnicity_1 == 1 ~ "Hispanic or Latino/Latina",
                    ethnicity_2 == 1 | (ethnicity_2 == 1 & ethnicity_9 == 1) ~ "Others",
                    ethnicity_3 == 1 | ethnicity_4 == 1 | ethnicity_5 == 1 ~ "Asians",
                    ethnicity_7 == 1 | (ethnicity_7 == 1 & ethnicity_9 == 1) ~ "Others",
                    ethnicity_8 == 1 | (ethnicity_8 == 1 & ethnicity_9 == 1) ~ "Others",
                    ethnicity_9 == 1 ~ "Whites",
                    TRUE ~ "Others"))
levels(df$ethnicity_4_cats)

df %>% count(ethnicity_4_cats)

df %>% 
  select(ethnicity_4_cats, segment) %>% 
  group_by(segment) %>% 
  count(ethnicity_4_cats)

```

### *how many whites chose other categories?*

```{r}
#Ethnicity 4 cats
df %>% 
  select(ethnicity_1:ethnicity_11, dem09, dem10, dem11) %>% #view_df()
  map_dbl(count)

# *how many whites chose other categories?*
df %>% 
  select(segment, ethnicity_4_cats, ethnicity_1:ethnicity_11, dem09, dem10, dem11) %>% 
  group_by(ethnicity_4_cats) %>% 
  count(ethnicity_11) # black, indigenous American, middle eastern
```

### With exclusive Ethnicity (single select) by segment*

```{r}

df %>% 
  select(ethnicity_4_cats, segment) %>% 
  create_barplot_by_segment(ethnicity_4_cats) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Ethnicity by Segment",
       subtitle = "N = 270. \nHispanics lead Identity Shoppers groups, while Aisans/whites lead Conventional Shoppers",
       caption = "ethnicity_4_cats, \nwhich is consolidated from multi-select categories of ethnicity_1 to ethnicity_11. \"Which of the following best describes your ethnicity? Please select all that apply.\"")

```

* The following categorization of whites leads to the same outcome as above.

```{r}
df %>% view_df()
df %>% 
  mutate(ethnicity_4_cats = case_when(ethnicity_1 == 1 ~ "Hispanic or Latino/Latina",
                               ethnicity_3 == 1 | ethnicity_4 == 1 | ethnicity_5 == 1 ~ "All Asians (East, South, Southeast)",
                               ethnicity_9 == 1 & (ethnicity_1 != 1 | 
                                                    ethnicity_2 != 1 |
                                                    ethnicity_3 != 1 |
                                                     ethnicity_4 != 1 |
                                                     ethnicity_5 != 1 |
                                                     ethnicity_6 != 1 |
                                                     ethnicity_7 != 1 |
                                                     ethnicity_8 != 1 |
                                                     ethnicity_10 != 1 |
                                                     ethnicity_11 != 1)  ~ "White",
                               TRUE ~ "Others")) %>% 
  mutate(ethnicity_4_cats = fct_relevel(ethnicity_4_cats, "Others", after = Inf),
         ethnicity_4_cats = fct_relevel(ethnicity_4_cats, "White", "Hispanic or Latino/Latina")) %>% 
  group_by(segment) %>% 
  count(ethnicity_4_cats)
            
```


### Ethnicity non-exclusive, multi-select approach

```{r}
df <- df %>% 
  mutate(ethnicity_asians_all = case_when(ethnicity_3 == 1 | ethnicity_4 == 1 | ethnicity_5 == 1 ~ 1,
                                          TRUE ~ 0)) %>% 
  set_value_labels(ethnicity_asians_all = c("All Asians (East, South, Southeast)" = 1))


df %>% 
  select(ethnicity_9, ethnicity_1, ethnicity_asians_all) %>% glimpse()

t_3_ethnicity <- df %>% tabulate_seg_by_cat(ethnicity_9) %>% 
bind_rows(df %>% tabulate_seg_by_cat(ethnicity_1)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(ethnicity_asians_all)) %>% ungroup()

t_3_ethnicity 

#white 
df %>% tabulate_seg_by_cat(ethnicity_9) %>% ungroup() %>% 
  filter(class != "0") %>% 
  summarise(sum = sum(n)) # white = 146

#Hispanic
df %>% tabulate_seg_by_cat(ethnicity_1) %>% ungroup() %>% 
  filter(class != "0") %>% 
  summarise(sum = sum(n)) # Hispanic = 60

#Asians 
df %>% tabulate_seg_by_cat(ethnicity_asians_all) %>% ungroup() %>% 
  filter(class != "0") %>% 
  summarise(sum = sum(n)) # Asians = 52

t_3_ethnicity %>% 
  filter(class != "0") %>% 
  create_barplot_multi_cat_by_segment(class)

```

## Interactive map with Customer Location

-   Reference <https://www.earthdatascience.org/courses/earth-analytics/get-data-using-apis/leaflet-r/>

```{r mapping locations of participants}
#install.packages("leaflet")
library(leaflet)
glimpse(df)
df %>% view_df()

# convert characters to numbers
df_map <- df %>% 
  select(location_latitude, location_longitude, recency, frequency, 
         spend, segment, gender, age, income, ethnicity_4_cats) %>% 
  mutate (location_latitude = as.numeric(location_latitude), 
          location_longitude = as.numeric(location_longitude),
          recency = haven::as_factor(recency),
          frequency = haven:: as_factor(frequency),
          spend = as_character(spend),
          gender = haven::as_factor(gender),
          age = as_character(age),
          ethnicity_4_cats)

# confirm
df_map %>% 
  select(location_latitude, location_longitude, recency, frequency, spend) %>% 
  glimpse()

# Create a leaflet map
leaflet(df_map) %>% 
  addTiles() %>% 
  addMarkers(lng = ~location_longitude, lat = ~location_latitude) 

# Connect customer location to their data (e.g., frequency of purchase at Farm Store or segment)
leaflet(df_map) %>% 
  addTiles() %>% 
  addMarkers(lng = ~location_longitude, lat = ~location_latitude, popup = ~ c(frequency)) 

view_df(df_map)

leaflet(df_map) %>% 
  addTiles() %>%  
  addMarkers(lng = ~location_longitude, lat = ~location_latitude, popup = ~ spend)

# Multiple variables in the pop-up
leaflet(df_map) %>% 
  addTiles() %>% 
  addMarkers(lng = ~location_longitude, lat = ~location_latitude, 
             popup = ~ paste0("Segment: ", segment, "<br>",
                             "Age: ", age, "<br>",
                             "Ethnicity: ", ethnicity_4_cats, "<br>",
                             "Frequency: ", frequency, " times last year", "<br>",
                             "Recency: ", recency, "<br>",
                             "Spending: ", "$", spend)) 
```


# Overall market insights (Alex)

## Spending on Groceries by segment

```{r}
df %>% view_df()
df %>% count(spend, sort = TRUE)

library(markdown)

df %>% 
  select(spend, segment) %>% 
  filter(!is.na(spend)) %>% # n = 259
  mutate(segment = haven::as_factor(segment)) %>% 
  group_by(segment) %>% 
  summarise(spend_avg = mean(spend, na.rm = TRUE)) %>% 
  mutate(segment = fct_reorder(segment, spend_avg)) %>% 
  ggplot(aes(x = spend_avg, y = segment, fill = segment)) +
  geom_col() +
  geom_text(aes(label = paste0("$", sprintf("%1.0f", spend_avg))),
        position = position_stack(vjust = 0.95),
        #color = "white",
        size = 3.5) +
  scale_x_continuous(labels = dollar_format()) +
   scale_fill_viridis(alpha = 1,
                      begin = 0.3,
                      end = 1,
                      direction = -1,
                      discrete = TRUE,
                      option = "D") +
  theme_bw()+
    theme(legend.position = "none") +
  labs(x = "Average Spending",
       y = NULL,
       title =  "Average Spending on Groceries by Segments",
       subtitle = "N = 259",
       caption = "Spend: \"What have you spent in total on these items in the past month? \n(Your best estimate is ok). Enter a numeric response.\"")


# function
Visualize_barplot_1_var <- function(tbl, var1, var2) {
  
  tbl %>% 
  ggplot(aes(x = {{var2}}, y = {{var1}}, fill = {{var1}})) +
  geom_col() +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 0.9),
            color = "black",
            size = 3.5) +
  scale_x_continuous(labels = percent) +
  scale_fill_viridis(alpha = 1,
                    begin = 0.3,
                    end = 1,
                    direction = 1,
                    discrete = TRUE,
                    option = "D") +
  theme_bw() +
  theme(legend.position = "none")
  }    
    

df %>% 
  select(spend, segment) %>% 
  filter(!is.na(spend)) %>% # n = 259
  mutate(segment = haven::as_factor(segment)) %>% 
  group_by(segment) %>% 
  summarise(spend_avg = mean(spend, na.rm = TRUE)) %>% 
  mutate(segment = fct_reorder(segment, spend_avg)) %>% 
  Visualize_barplot_1_var(spend_avg, segment) +
  labs(x = "Average Spending",
       y = NULL,
       title =  "Average Spending on Groceries by Segments",
       subtitle = "N = 259",
       caption = "Spend: \"What have you spent in total on these items in the past month? \n(Your best estimate is ok). Enter a numeric response.\"")
```

## Functions (*doesn't work*)

```{r}
Visualize_barplot_2_vars_seg <- function(tbl, segment, var2) {
  
  tbl %>% 
  ggplot(aes(x = percent, y = {{var2}}, fill = segment)) +
  geom_col() +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 0.9),
            color = "black",
            size = 3.5) +
  scale_x_continuous(labels = percent) +
  scale_fill_viridis(alpha = 1,
                    begin = 0.3,
                    end = 1,
                    direction = 1,
                    discrete = TRUE,
                    option = "D") +
  facet_grid(~ segment) +
  theme_bw() +
  theme(legend.position = "none")
  }    
    
```

## Recency by segment

```{r}
df %>% 
  #count(recency) %>% 
  create_barplot_by_segment(recency) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Recency by Segment",
       subtitle = "(N = 270)",
       caption = "recency. \n\"When was the last time you visited the Farm Store? Please select one response.\"")
```

## Purchased Items from Farm Store Last Month by Segment

* What have you bought in the past month from the CPP Farm Store? Please select all that apply. Fruit

```{r}
df %>% 
  count(associate_farmstore_1)

df %>% 
  select(segment, purchases_farmstore_1:purchases_farmstore_18)

t_seg_by_purchase_FS <- 
  df %>% tabulate_seg_by_cat(purchases_farmstore_1) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_2)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_3)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_4)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_5)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_6)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_7)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_8)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_9)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_10)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_11)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_12)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_13)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_14)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_15)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_16)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_17)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(purchases_farmstore_18)) %>% ungroup()
  
levels(t_seg_by_purchase_FS$class)

t_seg_by_purchase_FS %>% #select(class) %>% distinct()
mutate(class = fct_recode(class, "Baked goods ready to eat" = "Baked goods ready to eat (cookies, bread, sweet bread, muffins, etc.)",
                            "Frozen goods" = "Frozen goods (ready meals, ice cream, frozen veggies, etc.)",
                            "Specialty butter" = "Specialty butter (ie. pumpkin butter, apple butter, sweet potato butter, etc.)",
                            "Gifts \n(trinkets, stuffed animals, spoons, collectibles)" = "Gifts (trinkets, stuffed animals, spoons, collectibles)",
                            "Gift Packs – premade fruit gift box \ncontaining CPP grown citrus or avocados" = "Gift Packs – premade fruit gift box containing CPP grown citrus or avocados",
                            "Customizable gift box (e.g. gift box filled \nwith customer-selected and/or CPP grown citrus)" = "Customizable gift box (e.g. gift box filled with customer-selected non-perishable specialty goods and/or CPP grown citrus)",
                            "Jarred Specialty Jams/Sauces" = "Jarred Specialty Jams/Sauces (portobello mushroom pasta sauce, roasted garlic pasta sauce, etc.)")) %>% 
filter(class != "0") %>% 
create_barplot_multi_cat_by_segment(class) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Purchased from Farm Store in the Past Month by Segment",
       subtitle = "(N = 270)",
       caption = "purchases_farmstore_1 to purchases_farmstore_18 \n\"What have you bought in the past month from the CPP Farm Store? Please select all that apply.\"")
```

## Association with Farm Store by Segment

```{r}
df %>% 
  count(associate_farmstore_1)

df %>% 
  select(segment, associate_farmstore_1:associate_farmstore_17)

t_seg_by_association <- 
  df %>% tabulate_seg_by_cat(associate_farmstore_1) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_2)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_3)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_4)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_5)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_6)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_7)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_8)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_9)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_10)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_11)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_12)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_13)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_14)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_15)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_16)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(associate_farmstore_17)) %>% ungroup()
  
levels(t_seg_by_association$class)

t_seg_by_association %>% #select(class) %>% distinct()
  filter(class != "0") %>% 
  mutate(class = fct_recode(class, "Baked goods ready to eat" = "Baked goods ready to eat (cookies, bread, sweet bread, muffins, etc.)",
                            "Frozen goods" = "Frozen goods (ready meals, ice cream, frozen veggies, etc.)",
                            "Specialty butter" = "Specialty butter (ie. pumpkin butter, apple butter, sweet potato butter, etc.)",
                            "Gifts \n(trinkets, spoons, collectibles)" = "Gifts (trinkets, stuffed animals, spoons, collectibles)",
                            "Gift Packs - gift box with preselected items \n(e.g. an assortment of specialty foods)" = "Gift Packs - gift box with preselected items (e.g. an assortment of specialty foods)",
                            "Customizable gift box (e.g. gift box filled with customer-selected \nnon-perishable specialty goods and/or CPP grown citrus)" = "Customizable gift box (e.g. gift box filled with customer-selected non-perishable specialty goods and/or CPP grown citrus)",
                            "Jarred Specialty Jams/Sauces" = "Jarred Specialty Jams/Sauces (portobello mushroom pasta sauce, roasted garlic pasta sauce, etc.)")) %>% 
  create_barplot_multi_cat_by_segment(class) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Farm Store Associations by Segment",
       subtitle = "(N = 270)",
       caption = "associate_farmstore_1 to associate_farmstore_17 \n\"Which of the following do you associate most with the Farm Store? That is, when you think of the Farm Store, which types of products come to mind first? Please select up to 3.\"")
```

## Rreward Program usage by segment

```{r}
df %>% 
  #count(rewards_programs) %>% 
  select(segment, rewards_programs) %>% 
  filter(!is.na(rewards_programs)) %>% #n=265
  create_barplot_by_segment(rewards_programs) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Rewards Program Uage by Segment",
       subtitle = "N = 265. \nIdentity Shoppers are enrolled in rewards program the most.",
       caption = "Rewards_programs. \"Are you enrolled in any rewards program for any of \nthe specialty food stores previously listed or similar stores? Please select one response.\"")
```

## Frequency of Reward Usage by Segment

```{r}
df %>% 
  #count(rewards_frequency) %>% 
  select(segment, rewards_frequency) %>% 
  filter(!is.na(rewards_frequency)) %>% #n=126
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  mutate(rewards_frequency = fct_recode(rewards_frequency, "Each time I visit \nthe store the rewards \nprogram is associated with" = "Each time I visit the store the rewards program is associated with")) %>% 
  create_barplot_by_segment(rewards_frequency) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Reward Usage frequency by Segment",
       subtitle = "N = 126 (only among Rewards Program Participants)",
       caption = "rewards_frequency. \n\"How often do you use your rewards program? Select one response\"") 
```


## Attitudes toward digital rewards (clients requested this specifically)

### Types of rewards by segment

```{r}
df %>% #count(tpt12)
  count(rewards_type_2)

df %>% 
  select(segment, rewards_type_1:rewards_type_6)

t_seg_by_rewards_type <- 
  df %>% tabulate_seg_by_cat(rewards_type_1) %>% 
bind_rows(df %>% tabulate_seg_by_cat(rewards_type_2)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(rewards_type_3)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(rewards_type_4)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(rewards_type_5)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(rewards_type_6)) %>% ungroup()
  
levels(t_seg_by_rewards_type$class)

t_seg_by_rewards_type %>% #count(class)
filter(class != "0") %>% #count(class)
create_barplot_multi_cat_by_segment(class) +
labs(x = "Percent of Participants within segments",
     y = NULL,
     title = "Types of Rewards by Segment",
     subtitle = "N = 270. Identity Shoppers participate in Rewards Apps the most",
     caption = "rewards_type_1 to rewards_type_6. \n\"What is your preferred way of having a rewards program? Select all that apply\"") 
```


### Types of Perks Most Appealing by segment

```{r}
df %>% #count(tpt12)
  count(perks_1:perks_9)

t_seg_by_perks_type <- 
  df %>% tabulate_seg_by_cat(perks_1) %>% 
bind_rows(df %>% tabulate_seg_by_cat(perks_2)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(perks_3)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(perks_4)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(perks_5)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(perks_6)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(perks_7)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(perks_8)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(perks_9)) %>% ungroup()
  
levels(t_seg_by_perks_type$class)

t_seg_by_perks_type %>% #count(class)
filter(class != "0") %>% #count(class)
create_barplot_multi_cat_by_segment(class) +
theme(legend.position = "none") +
labs(x = "Percent of Participants within segments",
     y = NULL,
     title = "Most Appealing Types of Perks by Segment",
     subtitle = "(N = 270)",
     caption = "perks_1 to perks_9. \n\"Which of the following rewards program perks would you find most appealing? Please select up to 3\"") 
```

# Competitive landscape and Farm Store Associations (Ryan)

## Top 3 Reasons for Shopping at a Specialty Food Store by Segment

```{r}
df %>% #count(tpt12)
  count(product_store_attrib_3)

df %>% 
  select(segment, product_store_attrib_1:product_store_attrib_13)

t_seg_by_reasons <- 
  df %>% tabulate_seg_by_cat(product_store_attrib_1) %>% 
bind_rows(df %>% tabulate_seg_by_cat(product_store_attrib_2)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(product_store_attrib_3)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(product_store_attrib_4)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(product_store_attrib_5)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(product_store_attrib_6)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(product_store_attrib_7)) %>%   
bind_rows(df %>% tabulate_seg_by_cat(product_store_attrib_8)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(product_store_attrib_9)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(product_store_attrib_10)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(product_store_attrib_11)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(product_store_attrib_12)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(product_store_attrib_13)) %>% ungroup()
  
levels(t_seg_by_reasons$class)

t_seg_by_reasons %>% #count(class)
filter(class != "0") %>% #count(class)
mutate(class = fct_recode(class, "I enjoy contributing to the community" = "I enjoy contributing to the community (e.g., CPP students, the College of Agriculture)",
                          "I want their seasonal items" = "I want their seasonal items (ex. Eggnog, Pumpkins, Produce)")) %>% 
create_barplot_multi_cat_by_segment(class) +
labs(x = "Percent of Participants within segments",
     y = NULL,
     title = "Top 3 Reasons for Shopping at a Specialty Food Store by Segment",
     subtitle = "(N = 270)",
     caption = "product_store_attrib_1 to product_store_attrib_13. \n\"What are the top three reasons that you would go to a specialty food store, such as the Farm Store?\"") 
```

## Top 3 Reasons for Shopping at a Speciality Food Store in the sample

```{r}
df %>% 
  select(product_store_attrib_1) %>% 
  rename(class = product_store_attrib_1) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(class) %>% 
  tally() %>% 
  mutate(percent = n/sum(n))

tabulate_by_cat <- function(tbl, cat) {
  
  tbl %>% 
    select({{cat}}) %>% 
    rename(class = {{cat}}) %>% 
    mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
    group_by(class) %>% 
    tally() %>% 
    mutate(percent = n/sum(n))
}

t_by_reasons <- 
  df %>% tabulate_by_cat(product_store_attrib_1) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_2)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_3)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_4)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_5)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_6)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_7)) %>%   
bind_rows(df %>% tabulate_by_cat(product_store_attrib_8)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_9)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_10)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_11)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_12)) %>% 
bind_rows(df %>% tabulate_by_cat(product_store_attrib_13)) %>% ungroup()
  
levels(t_by_reasons$class)

t_by_reasons %>% #count(class)
filter(class != "0") %>% #count(class)
mutate(class = fct_recode(class, "I enjoy contributing to the community" = "I enjoy contributing to the community (e.g., CPP students, the College of Agriculture)",
                          "I want their seasonal items" = "I want their seasonal items (ex. Eggnog, Pumpkins, Produce)")) %>% 
create_barplot_multi_cat(class) +
labs(x = "Percent of Participants",
     y = NULL,
     title = "Top 3 Reasons for Shopping at a Specialty Food Store",
     subtitle = "(N = 270)",
     caption = "product_store_attrib_1 to product_store_attrib_13. \n\"What are the top three reasons that you would go to a specialty food store, such as the Farm Store?\"") 


```


## Items PUrhcased from Farm Store in the Past Month by Segment
.fun = mean, .desc = FALSE)

```{r}
df %>% 
  select(segment, purchases_farmstore_1:purchases_farmstore_18) %>% 
  pivot_longer(-segment, names_to = "class", values_to = "value") %>% 
  group_by(segment, class, value) %>% 
  tally() %>% 
  mutate(percent = n/sum(n)) %>% 
  ungroup() %>% 
  filter(value != 0) %>% 
  #mutate(value = haven::as_factor(value)) %>% 
  mutate(class = fct_recode(class, "Fruit" = "purchases_farmstore_1",
                            "Vegetables" = "purchases_farmstore_2",
                            "Wine" = "purchases_farmstore_3",
                            "Beer" = "purchases_farmstore_4",
                            "Orange Juice" = "purchases_farmstore_5",
                            "Honey" = "purchases_farmstore_6",
                            "Eggs" = "purchases_farmstore_7",
                            "Dairy" = "purchases_farmstore_8",
                            "Baked goods ready to eat" = "purchases_farmstore_9",
                            "Meat" = "purchases_farmstore_10",
                            "Frozen goods" = "purchases_farmstore_11",
                            "Specialty butter" = "purchases_farmstore_12",
                            "Gifts \n(trinkets, stuffed animals, spoons, collectibles)" = "purchases_farmstore_13",
                            "Gift Packs – premade fruit gift box \ncontaining CPP grown citrus or avocados" = "purchases_farmstore_14",
                            "Customizable gift box (e.g. gift box filled \nwith customer-selected and/or CPP grown citrus)" = "purchases_farmstore_15",
                            "Jarred Specialty Jams/Sauces" = "purchases_farmstore_16",
                            "Candy" = "purchases_farmstore_17",
                            "None of the above" = "purchases_farmstore_18")) %>% 
  create_barplot_multi_cat_by_segment(class) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Purchased from Farm Store in the Past Month by Segment",
       subtitle = "N = 270. Identity Shoppers and Novelty Hunters purchased vegetables and fruits more",
       caption = "purchases_farmstore_1 to purchases_farmstore_18 \n\"What have you bought in the past month from the CPP Farm Store? Please select all that apply.\"") 
  
```


# Loyalty by Segment

## Specialty Stores Shopped in 6 months by Segment

```{r}
df %>% count(brand_3)
  count(a1_brand_usage)

df %>% 
  select(segment, brand_1:brand_5)

t_seg_by_shop_6_months <- 
  df %>% tabulate_seg_by_cat(brand_1) %>% 
bind_rows(df %>% tabulate_seg_by_cat(brand_2)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(brand_3)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(brand_4)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(brand_5)) %>% 
bind_rows(df %>% tabulate_seg_by_cat(brand_6)) %>% ungroup()
  
levels(t_seg_by_shop_6_months$class)

t_seg_by_shop_6_months %>% #count(class)
filter(class != "0") %>% #count(class)
mutate(class = fct_recode(class, "Other" = "Other (please fill in)")) %>% 
create_barplot_multi_cat_by_segment(class) +
labs(x = "Percent of Participants within segments",
     y = NULL,
     title = "Shopped in the past 6 months by Segment",
     subtitle = "N = 270.",
     caption = "brand_1 to brand_6 \n\"Which of the following specialty food stores have you shopped at in the past six months? Please select all that apply.\"") 
```

*For the following, use only Farm store and Trader Joes for brands due to sample size:*

## Last Month's Frequency of Shopping at each brand

### Farm Store Shopping Frequency by segment

```{r}
view_df(df)

df %>% #select(a1_brand_overall)
  count(a1_brand_usage)

# This question was given only to those who didn't shopped at the Farm Store in the past six months
df %>% #select(a1_brand_overall)
  count(farm_store_sat) 

# Frequency of shopping at Farm Store by Segment
df %>% 
  filter(!is.na(a1_brand_usage)) %>%  #n = 190
  create_barplot_by_segment(a1_brand_usage) +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Frequency of Shopping in the last Month at the Farm Store by Segment",
       subtitle = "Out of those who shopped at least once in the past six months (N = 190)",
       caption = "a1_brand_usage. \n\"In the last month, how often did you shop at CPP's Farm Store? Please select one response.\"") 
```


###  Trade Joe's Shopping Frequency by segment

```{r}
view_df(df)

df %>% #select(a1_brand_overall)
  count(a2_brand_usage)

df %>% 
  filter(a2_brand_usage != 0) %>%  #n = 217
  create_barplot_by_segment(a2_brand_usage) +
   labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Last Month's Frequency of Shopping at Trader Joe's by Segment",
       subtitle = "Out of those who shopped at least once in the past six months (N = 217)",
       caption = "a2_brand_usage. \n\"In the last month, how often did you shop at Trader Joes? Please select one response.\"") 
```

### Shopping Frequency at Sprouts by segment

```{r}
df %>% 
  count(a4_brand_usage) %>% 
  mutate(cum_sum = cumsum(n)) # n = 180

df %>% 
  filter(!is.na(a4_brand_usage)) %>%  #n = 180
  create_barplot_by_segment(a4_brand_usage) +
   labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Last Month's Frequency of Shopping at Sprouts by Segment",
       subtitle = "Out of those who shopped at least once in the past six months (N = 180)",
       caption = "a4_brand_usage. \n\"In the last month, how often did you shop at Sprouts? Please select one response.\"") 
```

## Loyalty
### Heavy Users (> 2 times) of Brand: *out of Those answered brand* questions
* brand_1: Which of the following specialty food stores have you shopped at in the past six months? Please select all that apply. - Selected Choice CPP's Farm Store

```{r}
df %>% view_df()

df %>% count(brand_1)
df %>% calculate_sample_n(a1_brand_usage)

df %>% count(brand_2)
df %>% calculate_sample_n(a2_brand_usage)

df %>% count(brand_3)
df %>% calculate_sample_n(a3_brand_usage)

# farm store: a1_brand_usage
df %>% count(brand_1)

df <- df %>% 
  mutate(brand_1_c = ifelse(brand_1 == 0, NA, brand_1)) %>% 
  mutate(fs_gt_2_mon = case_when(a1_brand_usage %in% c(3, 4, 5) ~ 1,
                                  a1_brand_usage %in% c(1, 2, 6) ~ 0))
df %>% count(fs_gt_2_mon)
df %>% 
  group_by(brand_1_c) %>% 
  count(fs_gt_2_mon)

# Trader Joe's: a2_brand_usage
df %>% count(brand_2)

df <- df %>% 
  mutate(brand_2_c = ifelse(brand_2 == 0, NA, brand_2)) %>% 
  mutate(tj_gt_2_mon = case_when(a2_brand_usage %in% c(3, 4, 5) ~ 1,
                                  a2_brand_usage %in% c(1, 2, 6) ~ 0))
df %>% count(tj_gt_2_mon)
df %>% 
  group_by(brand_2_c) %>% 
  count(tj_gt_2_mon)

# Whole Foods: a3_brand_usage
df %>% count(brand_3)

df <- df %>% 
  mutate(brand_3_c = ifelse(brand_3 == 0, NA, brand_3)) %>% 
  mutate(wf_gt_2_mon = case_when(a3_brand_usage %in% c(3, 4, 5) ~ 1,
                                  a3_brand_usage %in% c(1, 2, 6) ~ 0))
df %>% count(wf_gt_2_mon)
df %>% 
  group_by(brand_3_c) %>% 
  count(wf_gt_2_mon)

# Sprouts: a4_brand_usage
df %>% count(brand_4)

df <- df %>% 
  mutate(brand_4_c = ifelse(brand_4 == 0, NA, brand_4)) %>% 
  mutate(sp_gt_2_mon = case_when(a4_brand_usage %in% c(3, 4, 5) ~ 1,
                                  a4_brand_usage %in% c(1, 2, 6) ~ 0))
df %>% count(sp_gt_2_mon)
df %>% 
  group_by(brand_4_c) %>% 
  count(sp_gt_2_mon)


# Pavilions: a5_brand_usage
df %>% count(brand_5)

df <- df %>% 
  mutate(brand_5_c = ifelse(brand_5 == 0, NA, brand_5)) %>% 
  mutate(pa_gt_2_mon = case_when(a5_brand_usage %in% c(3, 4, 5) ~ 1,
                                  a5_brand_usage %in% c(1, 2, 6) ~ 0))
df %>% count(pa_gt_2_mon)
df %>% 
  group_by(brand_5_c) %>% 
  count(pa_gt_2_mon)


# Others: a6_brand_usage
df %>% count(brand_6)

df <- df %>% 
  mutate(brand_6_c = ifelse(brand_6 == 0, NA, brand_6)) %>% 
  mutate(ot_gt_2_mon = case_when(a6_brand_usage %in% c(3, 4, 5) ~ 1,
                                  a6_brand_usage %in% c(1, 2, 6) ~ 0))
df %>% count(ot_gt_2_mon)
df %>% 
  group_by(brand_6_c) %>% 
  count(ot_gt_2_mon)

df %>% count(ot_gt_2_mon)
df %>% glimpse()

# visualization

df %>% 
  select(segment, contains("2_mon")) %>% 
  pivot_longer(-segment, names_to = "class", values_to = "value") %>% 
  group_by(class) %>% 
  filter(!is.na(value)) %>% 
  summarize(percent = mean(value, na.rm = TRUE),
            n = n()) %>% 
  mutate(class = fct_recode(class, "Farm Store" = "fs_gt_2_mon",
                            "Trader Joe's" = "tj_gt_2_mon",
                            "Whole Foods" = "wf_gt_2_mon",
                            "Sprouts" = "sp_gt_2_mon",
                            "Pavilions" = "pa_gt_2_mon",
                            "Others" = "ot_gt_2_mon")) %>% 
  create_barplot_multi_cat(class) +
  geom_text(aes(label = paste0("(n = ", n, ")")),
              position = position_stack(vjust = 0),
              color = "black",
              size = 3.5) +
  labs(x = "Percent of Participants",
     y = NULL,
     title = "Loyalty (Shopping more than two times Last Month)",
     subtitle = "Out of those who visited each store in the past six months, Others \nenjoyed the highest level of loyalty, followed by Pavilions and Trader Joes.",
     caption = "Compiling more than two times from a1_brand_usage to a6_brand_usage. \n\"In the last month, how often did you shop at [xxxxx]? Please select one response.\"") 
```

### Heavy Users (> 2 times) of Brand by segment: *out of those answered brand questions*

```{r}
df %>% 
  select(segment, contains("2_mon")) %>% 
  pivot_longer(-segment, names_to = "class", values_to = "value") %>% 
  group_by(segment, class) %>% 
  filter(!is.na(value)) %>% 
  summarize(percent = mean(value, na.rm = TRUE),
            n = n()) %>% 
  mutate(class = fct_recode(class, "Farm Store" = "fs_gt_2_mon",
                            "Trader Joe's" = "tj_gt_2_mon",
                            "Whole Foods" = "wf_gt_2_mon",
                            "Sprouts" = "sp_gt_2_mon",
                            "Pavilions" = "pa_gt_2_mon",
                            "Others" = "ot_gt_2_mon")) %>% 
  create_barplot_multi_cat_by_segment(class) +
  labs(x = "Percent of Participants",
     y = NULL,
     title = "Loyalty (Shopping more than two times Last Month)",
     subtitle = "Out of those who visited each store in the past six months, majority of Health Nuts and Solo Supporters are loyal \nto Pavilions and Others, while majority of Conventional Shoppers are loyalty to Others",
     caption = "Compiling more than two times from a1_brand_usage to a6_brand_usage. \n\"In the last month, how often did you shop at [xxxxx]? Please select one response.\"") 
```


## Top Loyalty at Brands: *out of those answered brand questions*
* Top Loyalty = (Frequency of Shopping 5+ times) 

```{r}
df %>% count(a1_brand_usage)
df <- df %>% 
  mutate(a1_brand_usage_c = ifelse(a1_brand_usage == 0, NA, a1_brand_usage)) %>% 
  mutate(a2_brand_usage_c = ifelse(a2_brand_usage == 0, NA, a2_brand_usage)) %>% 
  mutate(a3_brand_usage_c = ifelse(a3_brand_usage == 0, NA, a3_brand_usage)) %>% 
  mutate(a4_brand_usage_c = ifelse(a4_brand_usage == 0, NA, a4_brand_usage)) %>% 
  mutate(a5_brand_usage_c = ifelse(a5_brand_usage == 0, NA, a5_brand_usage)) %>% 
  mutate(a6_brand_usage_c = ifelse(a6_brand_usage == 0, NA, a6_brand_usage))

# confirmation
df %>% group_by(a1_brand_usage) %>% count(a1_brand_usage_c)
df %>% group_by(a2_brand_usage) %>% count(a2_brand_usage_c)
df %>% group_by(a3_brand_usage) %>% count(a3_brand_usage_c)
df %>% group_by(a4_brand_usage) %>% count(a4_brand_usage_c)
df %>% group_by(a5_brand_usage) %>% count(a5_brand_usage_c)
df %>% group_by(a6_brand_usage) %>% count(a6_brand_usage_c)


df <- df %>% 
  mutate(fs_5_more_mon = if_else(a1_brand_usage_c == 5, 1, 0)) %>% 
  mutate(tj_5_more_mon = if_else(a2_brand_usage_c == 5, 1, 0)) %>% 
  mutate(wf_5_more_mon = if_else(a3_brand_usage_c == 5, 1, 0)) %>% 
  mutate(sp_5_more_mon = if_else(a4_brand_usage_c == 5, 1, 0)) %>% 
  mutate(pv_5_more_mon = if_else(a5_brand_usage_c == 5, 1, 0)) %>% 
  mutate(ot_5_more_mon = if_else(a6_brand_usage_c == 5, 1, 0))

df %>% 
  select(segment, fs_5_more_mon:ot_5_more_mon) %>% 
  pivot_longer(-segment, "brand", "value") %>% 
  filter(!is.na(value)) %>% 
  group_by(brand) %>% 
  summarize(percent = mean(value),
            n = n()) %>% 
  mutate(brand = fct_recode(brand, "Farm Store" = "fs_5_more_mon",
                            "Trader Joe's" = "tj_5_more_mon",
                            "Whole Foods" = "wf_5_more_mon",
                            "Sprouts" = "sp_5_more_mon",
                            "Pavilions" = "pv_5_more_mon",
                            "Others" = "ot_5_more_mon")) %>% 
  create_barplot_multi_cat(brand) +
  geom_text(aes(label = paste0("(n = ", n, ")")),
              position = position_stack(vjust = 0),
              color = "black",
              size = 3.5) +
  labs(x = "Percent of Participants",
       y = NULL,
       title = "Top Loyalty (Shopping 5+ times Last Month)",
       subtitle = "Out of those who answered the questions, Others enjoyed the highlest level of loyalty, followed \nby Pavillion, Trader Joe's, and Sprouts.",
       caption = "Compiling 5+ times only from a1_brand_usage to a6_brand_usage. \n\"In the last month, how often did you shop at [xxxxx]? Please select one response.\"") 

```


## Top Loyalty (Frequency of Shopping 5+ times at Brands) by Segment: *out of those answered brand questions*

```{r}
df %>% 
  select(segment, fs_5_more_mon:ot_5_more_mon) %>% 
  pivot_longer(-segment, "brand", "value") %>% 
  filter(!is.na(value)) %>% 
  group_by(segment, brand) %>% 
  summarize(percent = mean(value),
            n = n()) %>% 
  mutate(brand = fct_recode(brand, "Farm Store" = "fs_5_more_mon",
                            "Trader Joe's" = "tj_5_more_mon",
                            "Whole Foods" = "wf_5_more_mon",
                            "Sprouts" = "sp_5_more_mon",
                            "Pavilions" = "pv_5_more_mon",
                            "Others" = "ot_5_more_mon")) %>% 
  create_barplot_multi_cat_by_segment(brand) +
  labs(x = "Percent of Participants",
       y = NULL,
       title = "Top Loyalty (Shopping 5+ times Last Month)",
       subtitle = "Across all segments, Farm Store has lower level of top loyalty.",
       caption = "Compiling 5+ times only from a1_brand_usage to a6_brand_usage. \n\"In the last month, how often did you shop at [xxxxx]? Please select one response.\"") 

```


# Brand Satisfaction

## Collapsing Brand Satisfaction data into dichotomous variables

```{r}
df <- df %>% 
  mutate(a1_brand_overall_c = case_when(a1_brand_overall %in% c(4, 5)    ~ 1, 
                                        a1_brand_overall %in% c(3, 2, 1) ~ 0),
         a2_brand_overall_c = case_when(a2_brand_overall %in% c(4, 5)    ~ 1, 
                                        a2_brand_overall %in% c(3, 2, 1) ~ 0),
         a3_brand_overall_c = case_when(a3_brand_overall %in% c(4, 5)    ~ 1, 
                                        a3_brand_overall %in% c(3, 2, 1) ~ 0),
         a4_brand_overall_c = case_when(a4_brand_overall %in% c(4, 5)    ~ 1, 
                                        a4_brand_overall %in% c(3, 2, 1) ~ 0),
         a5_brand_overall_c = case_when(a5_brand_overall %in% c(4, 5)    ~ 1, 
                                        a5_brand_overall %in% c(3, 2, 1) ~ 0),
         a6_brand_overall_c = case_when(a6_brand_overall %in% c(4, 5)    ~ 1, 
                                        a6_brand_overall %in% c(3, 2, 1) ~ 0)) #%>%   count(a6_brand_overall_c)


```


## Create a function to count sample size

```{r}

glimpse(df)

df %>% 
  select(a1_brand_overall_c:a6_brand_overall_c) %>% 
  map_dbl(., mean, na.rm = TRUE)

df %>% 
  calculate_sample_n(a1_brand_overall_c)

df %>% 
  count(a1_brand_overall_c) %>% 
  mutate(cum_count = cumsum(n))

calculate_sample_n <- function(tbl, var) {
  tbl %>% 
    count({{var}}) %>% 
    mutate(cum_n = cumsum(n))
}

```

##  Brand satisfaction in the sample

```{r}
# sample size for stores
sample_stores <- df %>% 
  select(a1_brand_overall_c: a6_brand_overall_c) %>% 
  pivot_longer(everything(), names_to = "store", values_to = "value") %>% 
  group_by(store) %>% 
  count(value) %>% 
  mutate(cum_n = cumsum(n)) %>% 
  filter(!is.na(value), value != 0)

# With sample size for store satisfaction questions
df %>% 
  select(segment, a1_brand_overall_c:a6_brand_overall_c) %>% 
  pivot_longer(-segment, names_to = "store", values_to = "value") %>% 
  group_by(store) %>% 
  summarize(percent = mean(value, na.rm = TRUE)) %>% 
  left_join(sample_stores) %>% 
  mutate(store = fct_recode(store, "Farm Store" = "a1_brand_overall_c",
                            "Trader Joes" = "a2_brand_overall_c",
                            "Whole Foods" = "a3_brand_overall_c",
                            "Sprouts" = "a4_brand_overall_c",
                            "Pavilions" = "a5_brand_overall_c",
                            "Other" = "a6_brand_overall_c")) %>% 
  create_barplot_multi_cat(store) +
  geom_text(aes(label = paste0("(n = ", cum_n, ")")),
              position = position_stack(vjust = 0),
              color = "black",
              size = 3.5) +
  labs(x = "Percent of Participants",
       y = NULL,
       title = "Brand Satisfaction",
       subtitle = "Sample size for each brand varies depending on participants' answers to \"brand\" question",
       caption = "a1_brand_overall to a6_brand_overall. \n\"Overall, how satisfied are you with [xxx]? Please select one response.\"") 


# Without sample size
df %>% 
  select(segment, a1_brand_overall_c:a6_brand_overall_c) %>% 
  pivot_longer(-segment, names_to = "store", values_to = "value") %>% 
  group_by(store) %>% 
  summarize(percent = mean(value, na.rm = TRUE)) %>% 
  mutate(store = fct_recode(store, "Farm Store" = "a1_brand_overall_c",
                            "Trader Joes" = "a2_brand_overall_c",
                            "Whole Foods" = "a3_brand_overall_c",
                            "Sprouts" = "a4_brand_overall_c",
                            "Pavilions" = "a5_brand_overall_c",
                            "Other" = "a6_brand_overall_c")) %>% 
  create_barplot_multi_cat(store) +
  labs(x = "Percent of Participants",
       y = NULL,
       title = "Brand Satisfaction",
       subtitle = "Sample size for each brand varies depending on participants' answers to \"brand\" question",
       caption = "a1_brand_overall to a6_brand_overall. \n\"Overall, how satisfied are you with [xxx]? Please select one response.\"") 
```


## Brand Satisfaction by segment (insights on favorite brands by segment) with complex facet_grid

```{r}
df %>% count(purchases_1)


df %>% 
  select(segment, a1_brand_overall, a2_brand_overall, a3_brand_overall, a4_brand_overall, a5_brand_overall, a6_brand_overall) %>% 
  pivot_longer(-segment, names_to = "store", values_to = "value") %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(segment, store, value) %>% 
  tally() %>% drop_na() %>% 
  mutate(percent = n/sum(n)) %>% 
  mutate(store = fct_recode(store, "Farm Store" = "a1_brand_overall",
                            "Trader Joes" = "a2_brand_overall",
                            "Whole Foods" = "a3_brand_overall",
                            "Sprouts" = "a4_brand_overall",
                            "Pavilions" = "a5_brand_overall",
                            "Other" = "a6_brand_overall")) %>% 
  ggplot(aes(percent, value, fill = segment)) +
  geom_col() +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 1.3),
            color = "black",
            size = 3.0) +
  scale_x_continuous(labels = percent) +
  scale_fill_viridis(alpha = 1,
                    begin = 0.3,
                    end = 1,
                    direction = 1,
                    discrete = TRUE,
                    option = "D") +
  theme_bw() +
  theme(legend.position = "none") +
  facet_grid(store ~ segment) +
  labs(x = "Percent of Participants within segments",
       y = "Percent of Satisfaction for each store within the segments",
       title = "Brand Satisfaction by Segment",
       subtitle = NULL,
       caption = "a1_brand_overall to a6_brand_overall. \n\"Overall, how satisfied are you with [xxx]? Please select one response.\"") 

df %>% count(a1_brand_overall)

df %>% select(a1_brand_overall, a2_brand_overall, a3_brand_overall, a4_brand_overall, a5_brand_overall, a6_brand_overall) %>% 
  count(a1_brand_overall)
```

## Brand Satisfaction by Segement by collapsing data

```{r}
df %>% count(purchases_1)

df %>% count(a1_brand_overall)

df %>% select(a1_brand_overall, a2_brand_overall, a3_brand_overall, a4_brand_overall, a5_brand_overall, a6_brand_overall) %>% 
  count(a1_brand_overall)


# Collapsing data into dichotomous variables

df <- df %>% #count(a2_brand_overall)
  mutate(a1_brand_overall_c = case_when(a1_brand_overall %in% c(4, 5)    ~ 1, 
                                        a1_brand_overall %in% c(3, 2, 1) ~ 0),
         a2_brand_overall_c = case_when(a2_brand_overall %in% c(4, 5)    ~ 1, 
                                        a2_brand_overall %in% c(3, 2, 1) ~ 0),
         a3_brand_overall_c = case_when(a3_brand_overall %in% c(4, 5)    ~ 1, 
                                        a3_brand_overall %in% c(3, 2, 1) ~ 0),
         a4_brand_overall_c = case_when(a4_brand_overall %in% c(4, 5)    ~ 1, 
                                        a4_brand_overall %in% c(3, 2, 1) ~ 0),
         a5_brand_overall_c = case_when(a5_brand_overall %in% c(4, 5)    ~ 1, 
                                        a5_brand_overall %in% c(3, 2, 1) ~ 0),
         a6_brand_overall_c = case_when(a6_brand_overall %in% c(4, 5)    ~ 1, 
                                        a6_brand_overall %in% c(3, 2, 1) ~ 0)) #%>%   count(a6_brand_overall_c)

glimpse(df)

df %>% 
  select(a1_brand_overall_c:a6_brand_overall_c) %>% 
  map_dbl(., mean, na.rm = TRUE)



df %>% 
  calculate_sample_n(a1_brand_overall_c)


df_store_sat 

df %>% 
  select(segment, a1_brand_overall_c:a6_brand_overall_c) %>% 
  pivot_longer(-segment, names_to = "store", values_to = "value") %>% 
  #mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(segment, store) %>% 
  summarize(percent = mean(value, na.rm = TRUE)) %>%
  ungroup() %>% 
  mutate(store = fct_recode(store, "Farm Store" = "a1_brand_overall_c",
                            "Trader Joes" = "a2_brand_overall_c",
                            "Whole Foods" = "a3_brand_overall_c",
                            "Sprouts" = "a4_brand_overall_c",
                            "Pavilions" = "a5_brand_overall_c",
                            "Other" = "a6_brand_overall_c")) %>% 
  mutate(store = fct_reorder(store, percent, .fun = mean)) %>%  
  ggplot(aes(percent, store, fill = segment)) +
  geom_col() +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 1.12),
            color = "black",
            size = 3.3) +
  scale_x_continuous(labels = percent) +
  scale_fill_viridis(alpha = 1,
                    begin = 0.3,
                    end = 1,
                    direction = 1,
                    discrete = TRUE,
                    option = "D") +
  facet_grid(~ segment) +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "Percent of Participants within segments",
       y = NULL,
       title = "Brand Satisfaction by Segment",
       subtitle = "Farm Store was most favored brand among Identity Shoppers and Health Nuts.",
       caption = "a1_brand_overall_c to a6_brand_overall_c, which were created by \ncollapsing top 2 satisfaction categories (very Satisfied/Satisfied) among those responded. \n\"Overall, how satisfied are you with [xxx]? Please select one response.\"") 

```


# Segment overview (Miranda)

## Barriers 
```{r}
barriers <- df %>% 
  tabulate_by_cat(barriers_1) %>% 
  bind_rows(df %>% tabulate_by_cat(barriers_2)) %>% 
  bind_rows(df %>% tabulate_by_cat(barriers_3)) %>% 
  bind_rows(df %>% tabulate_by_cat(barriers_4)) %>% 
  bind_rows(df %>% tabulate_by_cat(barriers_5)) %>% 
  bind_rows(df %>% tabulate_by_cat(barriers_6)) %>% 
  bind_rows(df %>% tabulate_by_cat(barriers_7)) %>% 
  bind_rows(df %>% tabulate_by_cat(barriers_8)) %>% 
  bind_rows(df %>% tabulate_by_cat(barriers_9)) %>% ungroup()
barriers

barriers %>% 
  filter(class != "0") %>% 
  create_barplot_multi_cat(class) +
  labs(x = "Percent of Participants in the sample",
       y = NULL,
       title = "Barriers for Shopping at a Sepciality Food Store like Farm Store",
       subtitle = "N = 270. Distance, Price, Lack of variety are top three barriers.",
       caption = "barriers_1 to barriers_9. \n\"What are the reasons that would prevent you from going to a specialty food store, such as the Farm Store? Please select up to 3 responses.\"") 
```


## Barriers by Segment

```{r}
df %>% view_df()

seg_by_barriers <- df %>% 
  tabulate_seg_by_cat(barriers_1) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(barriers_2)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(barriers_3)) %>%
  bind_rows(df %>% tabulate_seg_by_cat(barriers_4)) %>%
  bind_rows(df %>% tabulate_seg_by_cat(barriers_5)) %>%
  bind_rows(df %>% tabulate_seg_by_cat(barriers_6)) %>%
  bind_rows(df %>% tabulate_seg_by_cat(barriers_7)) %>%
  bind_rows(df %>% tabulate_seg_by_cat(barriers_8)) %>%
  bind_rows(df %>% tabulate_seg_by_cat(barriers_9)) %>% ungroup()

seg_by_barriers

seg_by_barriers %>% 
  filter(class != "0") %>% 
  create_barplot_multi_cat_by_segment(class) +
  labs(x = "Percent of Participants by Segment",
       y = NULL,
       title = "Barriers by Segment",
       subtitle = "N = 270. Distance is more significant barrier for Solo Supporters, \nPrice presents a greater hurdle for Solor Supporers and Conventional Shoppers. \nPrice is less of an issue for Health Nuts.",
       caption = "barriers_1 to barriers_9. \n\"What are the reasons that would prevent you from going to a specialty food store, such as the Farm Store? Please select up to 3 responses.\"") 
```

## Activities/Interests (activities_interests_1 to activities_interests_8)

```{r}
activities_interests <- df %>% 
  tabulate_by_cat(activities_interests_1) %>% 
  bind_rows(df %>% tabulate_by_cat(activities_interests_2)) %>% 
  bind_rows(df %>% tabulate_by_cat(activities_interests_3)) %>% 
  bind_rows(df %>% tabulate_by_cat(activities_interests_4)) %>% 
  bind_rows(df %>% tabulate_by_cat(activities_interests_5)) %>% 
  bind_rows(df %>% tabulate_by_cat(activities_interests_6)) %>% 
  bind_rows(df %>% tabulate_by_cat(activities_interests_7)) %>% 
  bind_rows(df %>% tabulate_by_cat(activities_interests_8)) %>% ungroup()
activities_interests

activities_interests %>% 
  filter(!is.na(class)) %>% 
  create_barplot_multi_cat(class) +
  labs(x = "Percent of Participants in the sample",
       y = NULL,
       title = "Activities and Interests",
       subtitle = "N = 270. Cooking ingredients, plants, and unique foods are top three items they bought among the options provided",
       caption = "activities_interests_1 to activities_interests_8 \n\"Which of the following have you bought in the last 3 months? Please select all that apply.\"") 
```


## Activities/Interests by segment

```{r}
Seg_by_activities_interests <- df %>% 
  tabulate_seg_by_cat(activities_interests_1) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(activities_interests_2)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(activities_interests_3)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(activities_interests_4)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(activities_interests_5)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(activities_interests_6)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(activities_interests_7)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(activities_interests_8)) %>% ungroup()
Seg_by_activities_interests

Seg_by_activities_interests %>% 
  filter(!is.na(class)) %>% 
  create_barplot_multi_cat_by_segment(class) +
  labs(x = "Percent of Participants in the sample",
       y = NULL,
       title = "Activities and Interests by Segment",
       subtitle = "N = 270. Novelty Hunters and Health Nuts were more interested in cooking ingredients and plants than ohter groups",
       caption = "activities_interests_1 to activities_interests_8 \n\"Which of the following have you bought in the last 3 months? Please select all that apply.\"") 
```

# Opportunity Analysis (Daniel)

## high vs. low spending groups by segment (within each segment)

```{r}
df %>% 
  count(spend, sort = TRUE)

df %>% 
  select(spend)
  summarise(mean = mean(spend, na.rm = TRUE),
            min = min(spend, na.rm = TRUE),
            max = max(spend, na.rm = TRUE),
            median = median(spend, na.rm = TRUE))

df <- df %>% 
  mutate(high_spend = if_else(spend >= 250, 1, 0))

df %>% 
  group_by(high_spend) %>% 
  count(highspend)


df <- df %>% 
  set_value_labels(high_spend = c("High Spender (>= $250)" = 1,
                                  "Low Spender (< $250)" = 0))
df %>% 
  create_barplot_by_segment(high_spend) +
  labs(x = "Percent of Participants in the sample",
       y = NULL,
       title = "High vs. Low Spender by Segment",
       subtitle = "N = 270. Majority of Novelty Hunters and Health Nuts are high spenders",
       caption = "high_spend, \nwhich was created from \"spend\" variable based on median split. \"You indicated that you have purchased these items in the past month: \nWhat have you spent in total on these items in the past month? (Your best estimate is ok). Enter a numeric response.\"")

```


## high vs. low Farm Store frequency by segment (within each segment)

```{r}
frequency
fs_usage

df %>% 
  count(frequency)

df %>% 
  count(fs_usage)

df <- df %>% 
  mutate(high_frequency = 
           case_when(frequency %in% c(4, 5, 6, 7) ~ "High Frequency (6+ in a year)",
                     frequency == 1 ~ "Low Frequency (less than 6 in a year)"))
df %>% count(high_frequency)

df %>% 
  create_barplot_by_segment(high_frequency) +
  labs(x = "Percent of Participants in the sample",
       y = NULL,
       title = "High vs. Low frequency by Segment",
       subtitle = "N = 270. Identify Shoppers shop more frequently than other segments",
       caption = "high_frequency, which is created from \"frequency\" variable. \n\"Approximately how many times did you visit the Farm Store in the past year? Please select one response.\"")

df <- df %>% 
  mutate(fs_frequency_month = 
           case_when(a1_brand_usage %in% c(2, 3, 4, 5) ~ "High Usage (2+ in a month",
                     a1_brand_usage %in% c(6, 1) ~ "Low Usage (Less than 2 in a month"))

df %>% 
  create_barplot_by_segment(fs_frequency_month) +
  labs(x = "Percent of Participants in the sample",
       y = NULL,
       title = "High vs. Low Usage by Segment",
       subtitle = "N = 270. Identify Shoppers shop more frequently than other segments",
       caption = "fs_frequency_month, which is created from \"a1_brand_usage\" variable. \n\"In the last month, how often did you shop at CPP Farm Store? Please select one response.\"")
```


## high vs. low Farm Store attributes (farm_store_rate_1-10) by segment (within each segment)

* farm_store_rate_1: Which of these phrases best describe CPP's Farm Store? Please select up to 3. High quality

```{r}
df <- df %>% 
  rowwise() %>% 
  mutate(farm_store_rate_sum = sum(c_across(farm_store_rate_1:farm_store_rate_10), na.rm = TRUE)) %>% ungroup()

df %>% #view()
  count(farm_store_rate_1)

df %>% 
  mutate(farm_store_rate_sum = as.factor(farm_store_rate_sum)) %>% 
  create_barplot_by_segment(farm_store_rate_sum) +
  labs(x = "Percent of Participants in the sample",
       y = "# of Positive attributes",
       title = "Farm Store Rating by Segment",
       subtitle = "N = 270. Conventional Shoppers are most positive about the Farm Store",
       caption = "farm_store_rate_sum, which is created from \"farm_store_rate_1 to farm_store_rate_10\" variables. \n\"Which of these phrases best describe CPP's Farm Store? Please select up to 3.\"")

summary(df$farm_store_rate_sum)
```

## Capturability

* Operationalized by (Thinks the farm store is high quality + close proximity to the farm store + 1 if low frequency 0 if not) / 3
  + farm_store_rate_1: High quality
  + a1_brand_perception_1_1: High quality
  + product_store_attrib_1: Convenience
  + fs_frequency_month: 
* Shows how much the spend of a customer could be potentially increased

```{r}
df %>% view_df()
df %>% count(product_store_attrib_1)
df %>% count(a1_brand_perception_1_1)
df %>% count(farm_store_rate_1)
df %>% count(fs_frequency_month)
df %>% count(fms29)

df <- df %>% 
  mutate(fs_hi_qual = ifelse((farm_store_rate_1 == 1 | a1_brand_perception_1_1 == 1), 1, 0)) #%>% 
  #mutate(fs_hi_qual = replace_na(fs_hi_qual, 0))
  
df %>% count(fs_hi_qual)

#df <- df %>% 
#  mutate(fs_low_freq = case_when(fs_frequency_month == "Low Usage (Less than 2 in a month" ~ 1,
#                                TRUE ~ 0))
df <- df %>% 
  mutate(fs_low_freq = if_else(fs_frequency_month == "Low Usage (Less than 2 in a month", 1, 0))

df %>% count(fs_low_freq)

df <- df %>% 
  mutate(capturability = (fs_hi_qual + product_store_attrib_1 + fs_low_freq) / 3)

df %>% glimpse()
df %>% count(capturability)

df %>% select(segment, capturability) %>% 
  group_by(segment) %>% 
  summarize(mean = mean(capturability, na.rm = TRUE),
            n = n())
  


```

## Opportunity:

* Operationalized by (spend/5000 + (1 if high frequency 0 if not) + purchases gift boxes + purchases alcohol) / 4
  + purchases_15: Customizable gift box 
  + purchases_3: Wine
  + purchases_4: Beer

* Shows the potential profit a customer can currently provide.

```{r}

df <- df %>% 
  mutate(fs_hi_freq = if_else(fs_frequency_month == "High Usage (2+ in a month", 1, 0))
df %>% count(fs_hi_freq)

df %>% count(purchases_3)
df %>% count(purchases_4)
df <- df %>% 
  mutate(alcohol = if_else(purchases_3 == 1 | purchases_4 == 1, 1, 0))
df %>% count(alcohol)

df %>% count(purchases_15)

df <- df %>% 
  mutate(opportunity = (spend/5000 + fs_hi_freq + purchases_13 + alcohol)/4)

df %>% select(segment, opportunity) %>% 
  group_by(segment) %>% 
  summarize(mean = mean(opportunity, na.rm = TRUE),
            n = n())
```

## Marketability:

* Operationalized by (Interacts with farm store on Instagram + interacts with farm store emails + thinks the farm store is high quality) / 3

* Shows the likely reachability and receptiveness of a particular customer in regard to marketing attempts

```{r}

```

# Extra Stuff

## Zip code in the map 

* *trying to figure out how to make it work*
* a code from the web.

* census: <https://catalog.data.gov/dataset/tiger-line-shapefile-2019-2010-nation-u-s-2010-census-5-digit-zip-code-tabulation-area-zcta5-na>

```{r}
# Loading packages
library(sf)
library(dplyr)

# loading shapefile with zip codes
zip_codes <- sf::st_read("tl_2019_us_zcta510/tl_2019_us_zcta510.shp")

# join that only keep data in df_count
zip_with_count <- zip_codes %>%
                        dplyr::right_join(df_count, by = c("ZCTA5CE10" = "zip"))

# quick and dirty plot
plot(zip_with_count["Count"])
```

## CPP students by segments

```{r}
df %>% 
  count(cpp_affiliation_students)

df <- df %>% 
  set_value_labels(cpp_affiliation_students = c("Not this category" = 0,
                                               "CPP Students" = 1)) 

df %>% 
  select(segment, cpp_affiliation_students) %>% 
  #filter(cpp_affiliation_students == 1) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(segment, cpp_affiliation_students) %>% 
  tally() %>% 
  mutate(percent = n/sum(n)) %>% 
  ggplot(aes(x = percent, y = cpp_affiliation_students, fill = segment)) +
  geom_bar(stat = "identity", fill = "#089845") +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 1.10),
            color = "black",
            size = 3.0) +
  scale_x_continuous(labels = percent_format()) +
  scale_fill_viridis_d(direction = -1) +
  facet_wrap(~ segment) +
  theme(legend.position = "none") +
  labs(x = "Percent of Participants",
       y = NULL,
       title = "CPP Affiliation (students) by Segment",
       subtitle = "Slolo Suppters and Conventional Shoppers \nhave greater percentage of students than other segments.")
```

## CPP Alumni by segment

```{r}
view_df(df)

df %>% 
  count(cpp_affiliation_3)

df <- df %>% 
  set_value_labels(cpp_affiliation_3 = c("Not this category" = 0,
                                               "CPP Alumni" = 1))

df %>% 
  select(segment, cpp_affiliation_3) %>% 
  #filter(cpp_affiliation_3 == 1) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(segment, cpp_affiliation_3) %>% 
  tally() %>% 
  mutate(percent = n/sum(n)) %>% 
  ggplot(aes(x = percent, y = cpp_affiliation_3, fill = segment)) +
  geom_bar(stat = "identity", fill = "#089845") +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 1.10),
            color = "black",
            size = 3.0) +
  scale_x_continuous(labels = percent_format()) +
  scale_fill_viridis_d(direction = -1) +
  facet_wrap(~ segment) +
  theme(legend.position = "none") +
  labs(x = "Percent of Participants",
       y = NULL,
       title = "Farm Store Associations by Segment",
       subtitle = "Identity Shoppers and Health Nuts have greater \npercent of alumns than other segments.")
```


## Segments by Affiliations

### Creating CPP Students (undergraduate + Grad)  

```{r}

# Creating cpp_affiliation_students
df <- df %>% 
  mutate(cpp_affiliation_students = case_when((cpp_affiliation_1 == 1 | cpp_affiliation_2 == 1) ~ 1,
                                              TRUE ~ 0)) %>% 
  set_variable_labels(cpp_affiliation_students = "CPP Students (Under + Graduate)") %>% 
  set_value_labels(cpp_affiliation_students = c("CPP Students" = 1, "Not this category" = 0)) 

df %>% count(cpp_affiliation_students)
```

### Segment by Students (Under + Grad)

```{r }
df %>% 
  count(cpp_affiliation_students)

df %>% 
  select(segment, cpp_affiliation_students) %>% 
  set_value_labels(cpp_affiliation_students = c("Not this category (n = 251)" = 0,
                                               "CPP Students (n = 19)" = 1)) %>% 
  filter(cpp_affiliation_students == 1) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(cpp_affiliation_students, segment) %>% 
  tally() %>% 
  mutate(percent = n/sum(n)) %>% 
  ggplot(aes(x = percent, y = segment, fill = cpp_affiliation_students)) +
  geom_bar(stat = "identity", fill = "#089845") +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 0.8),
            color = "white",
            size = 4.0) +
  scale_x_continuous(labels = percent_format()) +
  scale_fill_viridis_d(direction = -1) +
  facet_wrap(~ cpp_affiliation_students) +
  theme(legend.position = "none") +
  labs(x = "Percent of Participants",
       y = NULL,
       title = "Segment by Students",
       subtitle = "Majority of the students are either \nSolo Supporters or Conventional Shoppers.")
 
```

### By gathering all affiliation type
* The outcome shows that percentages are identical across all the segments (*Problem*)
  + Treat each affiliation type separately to avoid the problem.
  
```{r eval=FALSE}
glimpse(df)
view_df(df)
df %>% 
  select(segment, cpp_affiliation_3:cpp_affiliation_6, cpp_affiliation_students) %>% 
  #replace_with_na_at(.vars = c("cpp_affiliation_3", "cpp_affiliation_4", 
  #                             "cpp_affiliation_5", "cpp_affiliation_6", 
  #                             "cpp_affiliation_students"), 
  #                   condition = ~.x == 0) %>% 
  #rename('CPP Students' = cpp_affiliation_students,
  #       'CPP Alumni' = cpp_affiliation_3,
  #       'CPP Staff' = cpp_affiliation_4,
  #       'Related to CPP student' = cpp_affiliation_5,
  #       'Not CPP affiliated' = cpp_affiliation_6) %>% 
  pivot_longer(cols = -segment, names_to = "cpp_affiliation", values_to = "value") %>% 
  mutate(segment = haven::as_factor(segment)) %>% 
  mutate(cpp_affiliation = haven::as_factor(cpp_affiliation)) %>% 
  mutate(value = haven::as_factor(value)) %>% 
  group_by(cpp_affiliation, segment) %>% 
  tally() %>% 
  mutate(percent = n/sum(n)) %>% 
  ggplot(aes(x = n, y = segment, fill = cpp_affiliation)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 0.8),
            color = "white",
            size = 3.0) +
  facet_wrap(~ cpp_affiliation) +
  theme(legend.position = "none") +
  labs(x = "# of participants",
       y = "Segments",
       title = "Age Breakdown (%) by Segment Categories",
       subtitle = "Gen Z's are largely conventional shoppers or Lone Wolf. Millenials tend to be Conventional shoppers. \nGen X are Mostly Conventional Shopper or Novelty Hunters. Boomers II are everthing except for Identity shoppers. \nBoomers 1 are Lone Wolf and Health Nuts. Post War generation are largely lone Wolf and conventional shoppers. N = 270")
 
```

### Segment by CPP Alumni

```{r}
view_df(df)

df %>% count(cpp_affiliation_3)

df <- df %>% 
    set_value_labels(cpp_affiliation_3 = c("Not this category" = 0,
                                               "CPP Alums" = 1))

df %>% 
  select(segment, cpp_affiliation_3) %>% 
  set_value_labels(cpp_affiliation_3 = c("Not this category (n = 211)" = 0,
                                               "CPP Alums (n = 59)" = 1)) %>% 
  filter(cpp_affiliation_3 == 1) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 

  group_by(cpp_affiliation_3, segment) %>% 
  tally() %>% 
  mutate(percent = n/sum(n)) %>% 
  ggplot(aes(x = percent, y = segment, fill = cpp_affiliation_3)) +
  geom_bar(stat = "identity", fill = "#089845") +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 0.8),
            color = "white",
            size = 4.0) +
  scale_x_continuous(labels = percent_format()) +
  facet_wrap(~ cpp_affiliation_3) +
  theme(legend.position = "none") +
  labs(x = "Percent of Participants",
       y = NULL,
       title = "Segment by CPP Alums",
       subtitle = "Majority of alumns are eihter Health Nuts, \nConventional shoppers, or Novelty Hunters")
```

### Segment by CPP Staff

```{r}
df %>% count(cpp_affiliation_4)

df <- df %>% 
    set_value_labels(cpp_affiliation_4 = c("Not this category" = 0,
                                         "CPP Staff" = 1))
df %>% 
  set_value_labels(cpp_affiliation_4 = c("Not this category (n = 230)" = 0,
                                         "CPP Staff (n = 40)" = 1))
  filter(cpp_affiliation_4 == 1) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(cpp_affiliation_4, segment) %>% 
  tally() %>% 
  mutate(percent = n/sum(n)) %>% 
  ggplot(aes(x = percent, y = segment, fill = cpp_affiliation_4)) +
  geom_bar(stat = "identity", fill = "#089845") +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 0.8),
            color = "white",
            size = 4.0) +
  scale_x_continuous(labels = percent_format()) +
  facet_wrap(~ cpp_affiliation_4) +
  theme(legend.position = "none") +
  labs(x = "Percent of Participants",
       y = NULL,
       title = "Segment by CPP Staff",
       subtitle = "Majority of staff are eihter Conventionals \nShoppers or Novelty Hunters")
```

### Segment by Related to CPP Students

```{r}
df %>% count(cpp_affiliation_5)

df <- df %>% 
  set_value_labels(cpp_affiliation_5 = c("Not this category" = 0,
                                         "Related to CPP Students" = 1))

df %>% 
  select(segment, cpp_affiliation_5) %>% 
  set_value_labels(cpp_affiliation_5 = c("Not this category (n = 230)" = 0,
                                         "Related to CPP Students (n = 40)" = 1)) %>% 
  filter(cpp_affiliation_5 == 1) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 

  group_by(cpp_affiliation_5, segment) %>% 
  tally() %>% 
  mutate(percent = n/sum(n)) %>% 
  ggplot(aes(x = percent, y = segment, fill = cpp_affiliation_5)) +
  geom_bar(stat = "identity", fill = "#089845") +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 0.8),
            color = "white",
            size = 4.0) +
  scale_x_continuous(labels = percent_format()) +
  facet_wrap(~ cpp_affiliation_5) +
  theme(legend.position = "none") +
  labs(x = "Percent of Participants",
       y = NULL,
       title = "Segment by CPP Student-related customer Group",
       subtitle = "Majority of CPP Student-related customers are either \nConventionals Shoppers or Novelty Hunters")
```

### Segment by Not CPP Affiliated

```{r}
df %>% count(cpp_affiliation_6)

df <- df %>% 
  set_value_labels(cpp_affiliation_6 = c("Affiliated with CPP" = 0,
                                         "Not Affiliated with CPP" = 1)) 

df %>% 
  select(segment, cpp_affiliation_6) %>% 
  set_value_labels(cpp_affiliation_6 = c("Affiliated with CPP (n = 148)" = 0,
                                         "Not Affiliated with CPP (n = 122)" = 1)) %>% 
  #filter(cpp_affiliation_6 == 1) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 

  group_by(cpp_affiliation_6, segment) %>% 
  tally() %>% 
  mutate(percent = n/sum(n)) %>% 
  ggplot(aes(x = percent, y = segment, fill = cpp_affiliation_6)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 1.14),
            #color = "white",
            size = 4.0) +
  scale_x_continuous(labels = percent_format()) +
  scale_fill_viridis_d(direction = -1) +
  #scale_fill_discrete(low="#089845", high="yellow")+
  facet_wrap(~ cpp_affiliation_6) +
  theme(legend.position = "none") +
  labs(x = "Percent of Participants",
       y = NULL,
       title = "Segment by CPP Affiliation",
       subtitle = "Majority of customers who are not affiliedated with CPP \nare neihter Conventionals Shoppers or Solo Supporters")
```


## Segment by income_3_cat
```{r}
# Stacked bar chart: Not my favoriate
df %>% 
  filter(income_3_cat != "Others") %>% 
  select(income_3_cat, segment) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(income_3_cat, segment) %>% 
  tally() %>% 
  mutate(percent = n/sum(n),
         income_bracket_n = sum(n)) %>% 
  ggplot(aes(x = percent, y = income_3_cat, fill = segment)) +
  geom_col() +
  geom_text(aes(label = paste0(sprintf("%1.0f", percent*100),"%")),
          position = position_stack(vjust = 0.5),
          color = "black",
          size = 4) +
  scale_x_continuous(labels = percent) +
  scale_fill_viridis_d() +
  labs(x = "Percent of participants within income brackets" ,
       y = NULL,
       title = "Segment by Income",
       subtitle = "N = 208",
       caption = "Among those who earn $150K+, Novelty Hunters and Conventional Shoppers \nmake up maajority. Among $100-$150K, Convential Shoppers are the largest. \nAmong under $100K group, Solo Supporters are largest.")


# faceting: Easier to interpret than stacked bar chart
df %>% 
  filter(income_3_cat != "Others") %>% 
  select(income_3_cat, segment) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(income_3_cat, segment) %>% 
  tally() %>% 
  mutate(percent = n/sum(n),
         income_bracket_n = sum(n)) %>% 
  ggplot(aes(percent, segment, fill = income_3_cat)) +
  geom_col() +
  geom_text(aes(label = paste0(sprintf("%1.0f", percent*100),"%")),
            position = position_stack(vjust = 0.6),
            color = "grey",
            size = 4) +
  facet_grid(~ income_3_cat) +
  theme(legend.position = "none") +
  scale_x_continuous(labels = percent) +
  scale_fill_viridis_d(direction = 1) +
  labs(x = "Percent of participants within income brackets",
       y = NULL,
       title = "Segment by income",
       subtitle = "N = 208",
       caption = "Among those who earn $150K+, Novelty Hunters and Conventional Shoppers \nmake up maajority. Among $100-$150K, Convential Shoppers are the largest. \nAmong under $100K group, Solo Supporters are largest.")

```
## Segment by income_5_cat
```{r}

df %>% 
  select(income_5_cat, segment) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(income_5_cat) %>% 
  tally()


# faceting
df %>% 
  select(income_5_cat, segment) %>% 
  filter(income_5_cat != "Others") %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(income_5_cat, segment) %>% 
  tally() %>% 
  mutate(percent = n/sum(n)) %>% 
  ggplot(aes(percent, segment, fill = income_5_cat)) +
  geom_col() +
  geom_text(aes(label = paste0(sprintf("%1.0f", percent*100),"%")),
            position = position_stack(vjust = 0.6),
            color = "white",
            size = 4) +
  facet_grid(~ income_5_cat) +
  theme(legend.position = "none") +
  scale_x_continuous(labels = percent) +
  scale_fill_viridis_d() +
  labs(x = "Percent of participants within income brackets",
       y = NULL,
       title = "Segment by Income categories (%)",
       subtitle = "N = 208",
       caption = "Among those who earn $150K+, Novelty Hunters and Conventional Shoppers \nmake up maajority. Identity Shoppers are the largeest segment for $50-$75 income braket. \nAmong under $50K group, Solo Supporters and Novelty Hunters make up the majority. ")
 
```

## Segments by Age (4 categories)

```{r}
df %>% 
  select(age_4_cat, segment) %>% 
  mutate(across(where(haven::is.labelled), haven::as_factor)) %>% 
  group_by(age_4_cat, segment) %>% 
  tally() %>% 
  mutate(percent = n/sum(n)) %>% 
  ggplot(aes(x = percent, y = segment, fill = age_4_cat)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(sprintf("%1.0f", 100*percent),"%")),
            position = position_stack(vjust = 0.8),
            color = "white",
            size = 4.0) +
  scale_x_continuous(labels = percent) +
  scale_fill_viridis_d() +
  facet_grid(~ age_4_cat) +
  theme_bw() +
  labs(x = "Percent of participants within the age brackets",
       y = NULL,
       title = "Age Breakdown by Segment Categories (%)",
       subtitle = "N = 270",
       caption = "Gen Z's and Milleniels are largely conventional shoppers. Gen X are Mostly Conventional Shopper or Novelty Hunters. \nBoomers II are everthing except for Identity shoppers. \nBoomers 1 and Post War gen are Solo supporter, Health nuts and conventional shoppers.") +
  guides(fill = "none")
```


## Zip code

```{r}
install.packages("zipcodeR")
install.packages("sf")
library(sf)

library(zipcodeR)
library(tidyverse)

df %>% 
  count(location, sort = TRUE) %>% 
  mutate(percent = n/sum(n)*100) # %>% view()
```

## Heavy shopping (> 2 times) at Each Breand out of *total sample*

```{r}
df %>% count(a1_brand_usage)

df <- 
  df %>% 
  mutate(fs_gt_2_mon = if_else(a1_brand_usage %in% c(3, 4, 5), 
                                 "Farm Store", "0")) %>% 
  mutate(tj_gt_2_mon = if_else(a2_brand_usage %in% c(3, 4, 5), 
                                 "Trade Joe's", "0")) %>%
  mutate(wf_gt_2_mon = if_else(a3_brand_usage %in% c(3, 4, 5), 
                                 "Whole Foods", "0")) %>%
  mutate(sp_gt_2_mon = if_else(a4_brand_usage %in% c(3, 4, 5), 
                               "Sprouts", "0")) %>%
  mutate(pv_gt_2_mon = if_else(a5_brand_usage %in% c(3, 4, 5), 
                               "Pavilions", "0")) %>%
  mutate(ot_gt_2_mon = if_else(a6_brand_usage %in% c(3, 4, 5), 
                               "Others", "0")) 

df %>% 
  count(wf_gt_2_mon) %>% 
  mutate(cum_sum = cumsum(n)) 

t_loyalty_brands <- df %>% 
  tabulate_by_cat(fs_gt_2_mon) %>% 
  bind_rows(df %>% tabulate_by_cat(tj_gt_2_mon)) %>% 
  bind_rows(df %>% tabulate_by_cat(wf_gt_2_mon)) %>% 
  bind_rows(df %>% tabulate_by_cat(sp_gt_2_mon)) %>% 
  bind_rows(df %>% tabulate_by_cat(pv_gt_2_mon)) %>% 
  bind_rows(df %>% tabulate_by_cat(ot_gt_2_mon)) 

t_loyalty_brands %>% 
  filter(class != "0") %>%  
  create_barplot_multi_cat(class) +
  labs(x = "Percent of Participants in the sample",
       y = NULL,
       title = "Loyalty (Shopping more than two times Last Month)",
       subtitle = "N = 270. Trader Joe's leads loyalty, followed by Sprouts.",
       caption = "Compiling more than two times only from a1_brand_usage to a6_brand_usage. \n\"In the last month, how often did you shop at [xxxxx]? Please select one response.\"") 

 
```

## Heavy shopping (2+ times) at each brand

* 2 and more
```{r}

df <- 
  df %>% 
  mutate(fs_2_more_mon = if_else(a1_brand_usage %in% c(2, 3, 4, 5), 
                                 "Farm Store", "0")) %>% 
  mutate(tj_2_more_mon = if_else(a2_brand_usage %in% c(2, 3, 4, 5), 
                                 "Trade Joe's", "0")) %>%
  mutate(wf_2_more_mon = if_else(a3_brand_usage %in% c(2, 3, 4, 5), 
                                 "Whole Foods", "0")) %>%
  mutate(sp_2_more_mon = if_else(a4_brand_usage %in% c(2, 3, 4, 5), 
                               "Sprouts", "0")) %>%
  mutate(pv_2_more_mon = if_else(a5_brand_usage %in% c(2, 3, 4, 5), 
                               "Pavilions", "0")) %>%
  mutate(ot_2_more_mon = if_else(a6_brand_usage %in% c(2, 3, 4, 5), 
                               "Others", "0")) 

df %>% 
  count(wf_gt_2_mon) %>% 
  mutate(cum_sum = cumsum(n)) 

t_loyalty_2_more_brands <- df %>% 
  tabulate_by_cat(fs_2_more_mon) %>% 
  bind_rows(df %>% tabulate_by_cat(tj_2_more_mon)) %>% 
  bind_rows(df %>% tabulate_by_cat(wf_2_more_mon)) %>% 
  bind_rows(df %>% tabulate_by_cat(sp_2_more_mon)) %>% 
  bind_rows(df %>% tabulate_by_cat(pv_2_more_mon)) %>% 
  bind_rows(df %>% tabulate_by_cat(ot_2_more_mon)) 

t_loyalty_2_more_brands %>% 
  filter(class != "0") %>%  
  create_barplot_multi_cat(class) +
  labs(x = "Percent of Participants in the sample",
       y = NULL,
       title = "Heavy Users (Shopping two or more times Last Month)",
       subtitle = "N = 270.",
       caption = "Combining two and more times from a1_brand_usage to a6_brand_usage. \n\"In the last month, how often did you shop at [xxxxx]? Please select one response.\"")
```

## heavy Users (Frequency of Shopping 2+ times at Brands) by Segment

```{r}
df %>% glimpse()

t_segment_by_loyalty_2_more_brands <- df %>% 
  tabulate_seg_by_cat(fs_2_more_mon) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(tj_2_more_mon)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(wf_2_more_mon)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(sp_2_more_mon)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(pv_2_more_mon)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(ot_2_more_mon)) %>% ungroup()

t_segment_by_loyalty_2_more_brands %>% 
  filter(!is.na(class), 
         class != "0") %>% 
  create_barplot_multi_cat_by_segment(class) +
  labs(x = "Percent of Participants in the sample",
       y = NULL,
       title = "Heavy Users (Shopping 2+ times Last Month) by Segment",
       subtitle = "N = 270.",
       caption = "Combinding two and more times from a1_brand_usage to a6_brand_usage. \n\"In the last month, how often did you shop at [xxxxx]? Please select one response.\"") 

```

## Top Loyalty (Frequency of Shopping 5+ times) at Brands with *total sample*

```{r}
df <- 
  df %>% 
  mutate(fs_5_more_mon = if_else(a1_brand_usage == 5, "Farm Store", "0")) %>% 
  mutate(tj_5_more_mon = if_else(a2_brand_usage == 5, "Trade Joe's", "0")) %>%
  mutate(wf_5_more_mon = if_else(a3_brand_usage == 5, "Whole Foods", "0")) %>%
  mutate(sp_5_more_mon = if_else(a4_brand_usage == 5, "Sprouts", "0")) %>%
  mutate(pv_5_more_mon = if_else(a5_brand_usage == 5, "Pavilions", "0")) %>%
  mutate(ot_5_more_mon = if_else(a6_brand_usage == 5, "Others", "0")) 

df %>% glimpse()

t_high_loyalty_brands <- df %>% 
  tabulate_by_cat(fs_5_more_mon) %>% 
  bind_rows(df %>% tabulate_by_cat(tj_5_more_mon)) %>% 
  bind_rows(df %>% tabulate_by_cat(wf_5_more_mon)) %>% 
  bind_rows(df %>% tabulate_by_cat(sp_5_more_mon)) %>% 
  bind_rows(df %>% tabulate_by_cat(pv_5_more_mon)) %>% 
  bind_rows(df %>% tabulate_by_cat(ot_5_more_mon)) 

t_high_loyalty_brands %>% 
  filter(!is.na(class), 
         class != "0") %>% 
  create_barplot_multi_cat(class) +
  labs(x = "Percent of Participants in the sample",
       y = NULL,
       title = "Top Loyalty (Shopping 5+ times Last Month)",
       subtitle = "N = 270. Trader Joe's leads top loyalty, followed by Sprouts.",
       caption = "Compiling 5+ times only from a1_brand_usage to a6_brand_usage. \n\"In the last month, how often did you shop at [xxxxx]? Please select one response.\"") 

```


## Top Loyalty (Frequency of Shopping 5+ times at Brands) by Segment with *total sample*

```{r}
df %>% glimpse()

t_segment_by_high_loyalty_brands <- df %>% 
  tabulate_seg_by_cat(fs_5_more_mon) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(tj_5_more_mon)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(wf_5_more_mon)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(sp_5_more_mon)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(pv_5_more_mon)) %>% 
  bind_rows(df %>% tabulate_seg_by_cat(ot_5_more_mon)) %>% ungroup()

t_segment_by_high_loyalty_brands %>% 
  filter(!is.na(class), 
         class != "0") %>% 
  create_barplot_multi_cat_by_segment(class) +
  labs(x = "Percent of Participants in the sample",
       y = NULL,
       title = "Top Loyalty (Shopping 5+ times Last Month) by Segment",
       subtitle = "N = 270. Solo Supporters tend to be loyal",
       caption = "Compiling 5+ times only from a1_brand_usage to a6_brand_usage. \n\"In the last month, how often did you shop at [xxxxx]? Please select one response.\"") 

```
